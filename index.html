<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Britannia RGP System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --britannia-red: #D21F3C; 
            --britannia-yellow: #FFC72C; 
            --britannia-blue: #005596;
            --light-bg: #f4f6f9; 
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }
        
        /* --- GLOBAL LAYOUT FIXES --- */
        body { 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--light-bg); 
            overflow-x: hidden; 
        }
        
        /* --- LOGIN SCREEN --- */
        #login-screen { 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background-color: var(--light-bg); 
            position: fixed; 
            width: 100%; 
            z-index: 1000; 
            top: 0; 
            left: 0;
        }
        .login-card { 
            background: white; 
            padding: 2.5rem; 
            border-radius: 15px; 
            width: 400px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            border: 1px solid #eee;
        }

        /* --- HEADER --- */
        .app-header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 10px 20px;
            z-index: 100;
            height: 80px;
        }
        .header-center-logo {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* Logo display */
        .logo-img { 
            max-height: 60px; 
            object-fit: contain; 
        }
        .page-title { 
            font-weight: 700; 
            color: var(--britannia-red); 
            font-size: 1.2rem; 
            margin: 0; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            line-height: 1.2;
        }

        /* --- MAIN LAYOUT --- */
        #app-container { 
            flex: 1; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        .main-wrapper { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            height: 100%; 
        }
        .nav-column { 
            padding-right: 15px; 
            border-right: 1px solid #eee; 
            height: 100%; 
            overflow-y: auto; 
        }

        /* --- NAVIGATION BUTTONS (No change) --- */
        .nav-btn { 
            height: 55px; 
            border-radius: 8px; font-weight: 600; border: none; color: white; 
            display: flex; flex-direction: row; align-items: center; justify-content: start; 
            padding-left: 10px;
            transition: all 0.2s; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            margin-bottom: 10px;
            font-size: 0.9rem; 
        }
        .nav-btn i { font-size: 1.3rem; margin-right: 10px; width: 30px; text-align: center;}
        .nav-btn:hover { filter: brightness(1.1); transform: translateX(3px); }
        
        .bg-create { background: #28a745; } 
        .bg-return { background: #6610f2; }
        .bg-pending { background: #17a2b8; }
        .bg-extend { background: #e83e8c; } 
        .bg-total { background: #20c997; }
        .bg-analytics { background: var(--britannia-blue); } 
        .bg-overdue { background: var(--britannia-red); }

        /* --- KEY METRICS TILES & ANALYTICS WIDGETS --- */
        .metric-tile, .analytics-widget { 
            cursor: pointer; 
            transition: transform 0.2s; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            height: 100px; 
            padding: 10px 15px;
            position: relative; 
            background: white; 
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            align-items: flex-start;
        }
        .metric-tile:hover, .analytics-widget:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        
        /* FIX 4 & 5: Colouring the tile texts */
        .metric-tile h3, .analytics-widget h3 { font-size: 1.8rem; font-weight: 700; margin: 0; line-height: 1; }
        .metric-tile h6, .analytics-widget h6 { font-size: 0.85rem; font-weight: 600; color: #777; margin-bottom: 5px;}

        /* Specific colors for metrics */
        .tile-total h3 { color: var(--success-color); }
        .tile-open h3 { color: var(--warning-color); }
        .tile-closed h3 { color: var(--info-color); }
        .tile-overdue h3 { color: var(--britannia-red); }

        /* Specific colors for analytics widgets */
        #widget-total-items { color: var(--success-color); }
        #widget-outstanding-items { color: var(--britannia-red); }
        #widget-avg-cycle { color: var(--britannia-blue); }
        #widget-max-extension { color: var(--info-color); }


        /* Chart Stretching Fix */
        .chart-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            height: 350px; 
            position: relative; 
            margin-top: 10px;
        }

        .chart-card canvas {
            max-height: 100%;
            height: 100%;
            width: 100% !important; 
        }
        
        /* --- GENERAL VIEWS (No change) --- */
        .view-section { 
            height: 100%; 
            display: none; 
            animation: fadeIn 0.4s; 
            padding-bottom: 50px;
        }
        .table-custom th { background-color: var(--britannia-red); color: white; border: none; }
        .table-custom tr { cursor: pointer; } 

        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-Open { background: #d4edda; color: #155724; }
        .status-Overdue { background: #f8d7da; color: #721c24; }
        .status-Closed { background: #d1ecf1; color: #0c5460; }
        
        /* Specific styles for in-line details */
        .item-list-cell {
            font-size: 0.75rem; 
            line-height: 1.3;
        }
        .qty-cell {
            font-size: 0.75rem;
            text-align: center;
        }
        /* FIX 1: Material Description (details-col) now matches Sent By (vendor-col) */
        .rgp-no-col { min-width: 100px; }
        .date-col { min-width: 90px; }
        .details-col { min-width: 150px; } /* Changed from 160px to 150px to match vendor-col */
        .vendor-col { min-width: 150px; }
        /* FIX 2: Added Exp Date column width */
        .exp-date-col { min-width: 100px; }
        .qty-col { min-width: 80px; text-align: center; }
        .action-col { width: 100px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card text-center">
            <div style="height: 60px; margin-bottom: 1.5rem;">
                <img class="logo-img" alt="Britannia" src="https://www.britannia.co.in/_next/image?url=https%3A%2F%2Fmedia.britannia.co.in%2FBritannia_Logo_fcce3225c0.png&w=1080&q=100">
            </div>
            <h4 class="mb-4 text-secondary">Maintenance RGP System</h4>
            <div class="form-floating mb-3">
                <input type="text" id="username" class="form-control" placeholder="Username">
                <label>Username</label>
            </div>
            <div class="form-floating mb-4">
                <input type="password" id="password" class="form-control" placeholder="Password">
                <label>Password</label>
            </div>
            <button onclick="attemptLogin()" class="btn btn-danger w-100 py-2 fs-5">Login</button>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        
        <header class="app-header d-flex justify-content-between align-items-center position-relative">
            
            <div class="d-flex align-items-center">
                <button onclick="goHome()" class="btn btn-outline-secondary btn-sm me-3" id="btn-home" style="display:none;"><i class="fa fa-arrow-left"></i></button>
                <div id="header-title" class="page-title">RGP DASHBOARD</div>
            </div>
            
            <div class="header-center-logo">
                <img class="logo-img" alt="Britannia Logo" src="https://www.britannia.co.in/_next/image?url=https%3A%2F%2Fmedia.britannia.co.in%2FBritannia_Logo_fcce3225c0.png&w=1080&q=100">
            </div>

            <div style="width: 150px;" class="text-end">
                <button onclick="location.reload()" class="btn btn-sm btn-danger"><i class="fa fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <div class="container-fluid main-wrapper">
            
            <div id="view-dashboard" class="view-section active">
                <div class="row h-100"> 
                    
                    <div class="col-md-2 nav-column">
                        <h5 class="text-muted mb-3 ps-1">Navigation</h5>
                        <button class="nav-btn bg-create" onclick="navigateTo('create')" id="nav-create"><i class="fa fa-plus-circle"></i> Create RGP</button>
                        <button class="nav-btn bg-return" onclick="navigateTo('return')" id="nav-return"><i class="fa fa-undo"></i> Return Entry</button>
                        <button class="nav-btn bg-pending" onclick="navigateTo('pending', 'OpenOrOverdue')"><i class="fa fa-clock"></i> Pending List</button>
                        <button class="nav-btn bg-extend" onclick="navigateTo('extend')" id="nav-extend"><i class="fa fa-calendar-plus"></i> Extend RGP</button>
                        <button class="nav-btn bg-total" onclick="navigateTo('total')"><i class="fa fa-table-list"></i> Total List</button>
                        <button class="nav-btn bg-analytics" onclick="navigateTo('analytics')"><i class="fa fa-chart-pie"></i> Analytics</button>
                        <button class="nav-btn bg-overdue" onclick="navigateTo('overdue', 'Overdue')"><i class="fa fa-bell"></i> Overdue List</button>
                    </div>

                    <div class="col-md-10 ps-4">
                        <h5 class="text-secondary fw-bold mb-3">RGP Key Metrics</h5>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="card metric-tile tile-total" onclick="navigateTo('total')">
                                    <h6>Total RGPs</h6>
                                    <h3 id="metric-total">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-tile tile-open" onclick="navigateTo('pending', 'Open')">
                                    <h6>Open RGPs</h6>
                                    <h3 id="metric-open">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-tile tile-closed" onclick="navigateTo('total', 'Closed')">
                                    <h6>Closed RGPs</h6>
                                    <h3 id="metric-closed">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-tile tile-overdue" onclick="navigateTo('overdue', 'Overdue')">
                                    <h6>Overdue RGPs</h6>
                                    <h3 id="metric-overdue">0</h3>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="text-muted mb-3 mt-4">Live Analytics (Open RGPs)</h5>
                        
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="chart-card">
                                    <h6 class="text-center text-secondary">Top 5 Vendors (Open RGPs)</h6>
                                    <canvas id="chartVendor"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-card">
                                    <h6 class="text-center text-secondary">Top 5 Users (Open RGPs)</h6>
                                    <canvas id="chartSentBy"></canvas>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div id="view-create" class="view-section container">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        <form id="createRgpForm">
                            <div class="row mb-3">
                                <div class="col-md-4"><label class="form-label text-muted">RGP Number</label><input type="text" id="rgpNo" class="form-control fw-bold" required></div>
                                <div class="col-md-4"><label class="form-label text-muted">RGP Date</label><input type="date" id="rgpDate" class="form-control" required></div>
                                <div class="col-md-4"><label class="form-label text-muted">Exp. Return Date</label><input type="date" id="expDate" class="form-control" required></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6"><label class="form-label text-muted">Sent By</label><input type="text" id="sentBy" class="form-control" required></div>
                                <div class="col-md-6"><label class="form-label text-muted">Receiver / Vendor</label><input type="text" id="vendor" class="form-control" required></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted">No. of Items</label>
                                <input type="number" id="itemCount" class="form-control w-25" min="1" value="1" onchange="generateItemRows()">
                            </div>
                            <table class="table table-bordered align-middle">
                                <thead class="table-light"><tr><th>Material Description</th><th>Quantity</th></tr></thead>
                                <tbody id="itemsContainer"></tbody>
                            </table>
                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <button type="button" class="btn btn-light" onclick="goHome()">Cancel</button>
                                <button type="submit" class="btn btn-success px-4"><i class="fa fa-save me-2"></i>Save RGP</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="view-list" class="view-section container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 id="list-subtitle" class="text-muted">Records</h5>
                    <button onclick="exportTableToExcel('dataTable', 'rgp_data')" class="btn btn-outline-success btn-sm"><i class="fa fa-file-excel"></i> Export Excel</button>
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-md-4">
                        <input type="text" id="listSearch" class="form-control" placeholder="Search RGP, Vendor, Item..." onkeyup="filterList()">
                    </div>
                    <div class="col-md-3" id="statusFilterDiv" style="display:none;">
                        <select id="statusFilter" class="form-select" onchange="filterList()">
                            <option value="">All Statuses</option>
                            <option value="Open">Open</option>
                            <option value="Closed">Closed</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button onclick="resetListFilters()" class="btn btn-secondary w-100">Clear</button>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-custom mb-0" id="dataTable">
                            <thead>
                                <tr>
                                    <th class="rgp-no-col">RGP No</th>
                                    <th class="date-col">RGP Date</th>
                                    <th class="details-col">Material Description</th>
                                    <th class="vendor-col">Sent By</th>
                                    <th class="vendor-col">Vendor / Receiver</th>
                                    <th class="exp-date-col">Exp. Return Date</th>
                                    <th class="qty-col">Initial Qty</th>
                                    <th class="qty-col">Returned Qty</th>
                                    <th class="qty-col">Remaining Qty</th>
                                    <th>Status</th>
                                    <th class="action-col" id="col-action">Action</th>
                                </tr>
                            </thead>
                            <tbody id="listBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-return" class="view-section container-fluid">
                <div class="card p-4 shadow-sm border-0 mb-4">
                    <label class="form-label text-muted">Search RGP / Vendor / Material Description</label>
                    <input type="text" id="returnSearchRgp" class="form-control form-control-lg" placeholder="Type to filter the list below..." onkeyup="filterReturnList()">
                </div>
                
                <h6 class="text-muted mb-3">Open RGPs Awaiting Return (Click a row to enter return quantities):</h6>
                
                <div class="card shadow-sm border-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-custom mb-0" id="returnTable">
                            <thead>
                                <tr>
                                    <th class="rgp-no-col">RGP No</th>
                                    <th class="date-col">RGP Date</th>
                                    <th class="details-col">Material Description</th>
                                    <th class="vendor-col">Sent By</th>
                                    <th class="vendor-col">Vendor / Receiver</th>
                                     <th class="exp-date-col">Exp. Return Date</th>
                                    <th class="qty-col">Initial Qty</th>
                                    <th class="qty-col">Returned Qty</th>
                                    <th class="qty-col">Remaining Qty</th>
                                    <th>Status</th>
                                    <th class="action-col">Action</th>
                                </tr>
                            </thead>
                            <tbody id="returnListBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="returnEntryArea" style="display:none;" class="card p-4 shadow-sm border-0 mt-4">
                    <h5 id="returnRgpHeader" class="text-primary mb-3"></h5>
                    <table class="table">
                        <thead class="table-light"><tr><th>Material</th><th>Initial Qty</th><th>Returned</th><th>Outstanding</th><th>Return Now</th></tr></thead>
                        <tbody id="returnItemsBody"></tbody>
                    </table>
                    <div class="text-end">
                        <button onclick="submitReturn()" class="btn btn-primary btn-lg"><i class="fa fa-check-circle me-2"></i>Save Return Entry</button>
                    </div>
                </div>
            </div>


            <div id="view-extend" class="view-section container-fluid">
                <div class="card p-4 shadow-sm border-0 mb-4">
                    <label class="form-label text-muted">Search RGP / Vendor / Sent By</label>
                    <input type="text" id="extendSearchRgp" class="form-control form-control-lg" placeholder="Type to filter the list below..." onkeyup="filterExtendList()">
                </div>

                <h6 class="text-muted mb-3">Open RGPs for Extension (Click Extend button or row for details):</h6>
                <div class="card shadow-sm border-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-custom mb-0" id="extendTable">
                             <thead>
                                <tr>
                                    <th class="rgp-no-col">RGP No</th>
                                    <th class="date-col">RGP Date</th>
                                    <th class="details-col">Material Description</th>
                                    <th class="vendor-col">Sent By</th>
                                    <th class="vendor-col">Vendor / Receiver</th>
                                     <th class="exp-date-col">Exp. Return Date</th>
                                    <th class="qty-col">Initial Qty</th>
                                    <th class="qty-col">Returned Qty</th>
                                    <th class="qty-col">Remaining Qty</th>
                                    <th>Status</th>
                                    <th class="action-col">Action</th>
                                </tr>
                            </thead>
                            <tbody id="extendListBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="extendFormArea" class="card p-4 shadow-sm border-0 bg-light mt-4" style="display:none;">
                    <h5 class="text-danger mb-3">Extending: <span id="extendRgpId"></span></h5>
                    <div class="row">
                        <div class="col-md-6"><label class="form-label">New Return Date</label><input type="date" id="newExtendDate" class="form-control"></div>
                        <div class="col-md-6"><label class="form-label">Reason for Extension</label><input type="text" id="extendReason" class="form-control"></div>
                    </div>
                    <button onclick="submitExtension()" class="btn btn-warning mt-3 text-dark fw-bold">Update Extension Date</button>
                </div>
            </div>

            <div id="view-analytics" class="view-section container">
                 <h5 class="text-secondary fw-bold mb-4">Detailed RGP Analytics (All Records)</h5>
                 
                 <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card analytics-widget" onclick="navigateTo('total', 'MaterialCount')">
                            <h6>Total Items Moved</h6>
                            <h3 id="widget-total-items">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card analytics-widget" onclick="navigateTo('total', 'OpenItemCount')">
                            <h6>Outstanding Items</h6>
                            <h3 id="widget-outstanding-items">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card analytics-widget" onclick="navigateTo('total', 'AvgCycleTime')">
                            <h6>Avg. Cycle Time (Days)</h6>
                            <h3 id="widget-avg-cycle">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card analytics-widget" onclick="navigateTo('total', 'MaxExtensions')">
                            <h6>Max Extensions (RGP No.)</h6>
                            <h3 id="widget-max-extension">N/A</h3>
                        </div>
                    </div>
                 </div>
                 
                 <div class="row g-4">
                    <div class="col-md-6">
                        <div class="chart-card">
                            <h6 class="text-center text-secondary">RGP Status Distribution</h6>
                            <canvas id="chartStatus"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-card">
                            <h6 class="text-center text-secondary">RGP Creation Over Time (Last 12 Months)</h6>
                            <canvas id="chartDateDistribution"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-card">
                            <h6 class="text-center text-secondary">Top 5 Vendors (Open RGPs)</h6>
                            <canvas id="chartVendorFull"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-card">
                            <h6 class="text-center text-secondary">Top 5 Users (Open RGPs)</h6>
                            <canvas id="chartSentByFull"></canvas>
                        </div>
                    </div>
                 </div>
            </div>

        </div> </div>

    <div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="actionModalLabel">RGP Actions - <span id="modalRgpNo"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">RGP Date: <span id="modalRgpDate"></span> | Exp. Return: <span id="modalExpDate"></span> | Status: <span id="modalStatus"></span></p>
                    <p>Vendor: <span id="modalVendor"></span> | Sent By: <span id="modalSentBy"></span></p>
                    
                    <h6 class="mt-3">Material Details</h6>
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Description</th>
                                <th>Initial Qty</th>
                                <th>Returned Qty</th>
                                <th>Remaining Qty</th>
                            </tr>
                        </thead>
                        <tbody id="modalItemsBody">
                            </tbody>
                    </table>

                    <div class="d-flex justify-content-end gap-3 mt-4">
                        <button class="btn btn-warning" id="btnExtendModal" data-rgp-id="" onclick="promptExtension(this.dataset.rgpId, this.dataset.rgpNo)" disabled><i class="fa fa-calendar-plus me-2"></i>Extend RGP</button>
                        <button class="btn btn-primary" id="btnReturnModal" data-rgp-id="" onclick="navigateToReturn(this.dataset.rgpId)" disabled><i class="fa fa-undo me-2"></i>Enter Return</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        // MODIFICATION: Import onSnapshot for real-time updates
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // *** CONFIGURATION ***
        // MODIFICATION: Replaced placeholder with actual Firebase Project Config
        const firebaseConfig = {
            apiKey: "AIzaSyCdkXlsPqTqRFrvzsVRtXy-tElXziLUjK8",
            authDomain: "rgpdashbid1.firebaseapp.com",
            projectId: "rgpdashbid1",
            storageBucket: "rgpdashbid1.firebasestorage.app",
            messagingSenderId: "807531684156",
            appId: "1:807531684156:web:8afe38be695c6056237e39",
            measurementId: "G-PTNFNMJEXG"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (e) { console.error("Firebase Initialization Error:", e); }

        // --- GLOBAL VARIABLES ---
        // MODIFICATION: Renamed to rgpRecords to distinguish from the Firestore collection name
        let rgpRecords = []; 
        let currentView = 'dashboard';
        let chartInstances = {}; // Centralized storage for chart instances
        // MODIFICATION: Global variable for user role
        let currentUserRole = 'staff'; 

        // --- LOCAL STORAGE FUNCTIONS (Persistence Layer) ---
        // Retained for original logic, but will be bypassed/modified to use Firestore
        const LOCAL_STORAGE_KEY = 'britannia_rgp_data';
        let rgpIdCounter = 100;

        // MODIFICATION: Removed placeholder data generation as Firestore will be the source.
        function generateInitialPlaceholderData() { return []; } 

        /** Saves the current allRgps array to Local Storage (retained for fallback/initial structure) */
        function saveRgpsToLocalStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(rgpRecords));
            } catch (error) {
                console.error("Error saving to Local Storage:", error);
            }
        }

        /** Loads data from Local Storage or uses placeholder if empty (retained, but Firestore will now populate rgpRecords) */
        function loadRgpsFromLocalStorage() {
            // Note: This function is now mainly a placeholder for backward compatibility,
            // as Firestore will be actively managing the rgpRecords array.
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                try {
                    rgpRecords = JSON.parse(storedData);
                    const maxIdNum = rgpRecords.reduce((max, r) => {
                        // Note: The structure of IDs (e.g., 'RGP_1') is no longer strictly needed
                        // as Firestore IDs will be used, but this logic is retained.
                        const num = parseInt(r.id.split('_')[1] || 0);
                        return num > max ? num : max;
                    }, 0);
                    rgpIdCounter = maxIdNum + 1;
                    return true;
                } catch (error) {
                    console.error("Error parsing Local Storage data, loading empty array:", error);
                    rgpRecords = generateInitialPlaceholderData();
                }
            } else {
                 rgpRecords = generateInitialPlaceholderData();
            }
            return true;
        }

        /** Utility to find an RGP by its unique ID */
        function findRgpById(id) {
            // MODIFICATION: Search against rgpRecords array, which is now populated by Firestore
            return rgpRecords.find(r => r.id === id);
        }
        // --- END LOCAL STORAGE FUNCTIONS ---

        // --- UTILITY: DATE FORMATTING (DD/MM/YYYY) ---
        /** Converts YYYY-MM-DD to DD/MM/YYYY */
        function formatDate(isoDate) {
            if (!isoDate || typeof isoDate !== 'string') return '';
            const parts = isoDate.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return isoDate; 
        }

        // --- UTILITY: SUCCESS TOAST ---
        const showSuccessToast = (title) => {
            Swal.fire({
                icon: 'success',
                title: title,
                toast: true,
                position: 'bottom-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        };


        // --- AUTH ---
        window.attemptLogin = () => {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            // MODIFICATION: Added manager login credentials and role assignment
            if (u === 'enoffbid1' && p === 'store.bid1') {
                currentUserRole = 'staff';
                initializeApplication();
            } else if (u === 'manager' && p === 'managerbid1') {
                currentUserRole = 'manager';
                initializeApplication();
            } else {
                Swal.fire('Error', 'Invalid Credentials', 'error');
            }
        };
        
        // MODIFICATION: New function to manage UI state post-login
        function initializeApplication() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex'; 
            applyRBAC(); // Apply access control right after login
            startRealtimeListener(); // Start listening for data changes
            goHome();
        }
        
        // MODIFICATION: Function to hide/show navigation and action buttons based on role
        function applyRBAC() {
            const isStaff = currentUserRole === 'staff';
            
            // 1. Navigation Buttons
            document.getElementById('nav-create').style.display = isStaff ? 'flex' : 'none';
            document.getElementById('nav-return').style.display = isStaff ? 'flex' : 'none';
            document.getElementById('nav-extend').style.display = isStaff ? 'flex' : 'none';
            
            // 2. Action Buttons in Modals/Lists (The "Action" column is still present, but the action *buttons* are hidden/disabled)
            // The modal buttons are handled within showActionModal/renderTable, but we disable the create/return/extend views for manager here
        }

        // --- FIREBASE REAL-TIME LISTENER & DATA SYNC ---
        // MODIFICATION: New function for real-time data access
        function startRealtimeListener() {
            if (!db) return; // Skip if Firebase failed to initialize

            const rgpsCollection = collection(db, "rgps");
            
            // onSnapshot sets up a continuous, real-time listener
            onSnapshot(rgpsCollection, (snapshot) => {
                const updatedRgps = snapshot.docs.map(doc => ({
                    id: doc.id, // Use Firestore document ID as the unique ID
                    ...doc.data()
                }));
                
                // Update global data array
                rgpRecords = updatedRgps; 
                
                // Recalculate Overdue status (retained logic)
                const today = new Date().toISOString().split('T')[0];
                rgpRecords.forEach(r => {
                    // This update only happens in the local array, not Firestore, 
                    // as 'Overdue' is a calculated status based on 'expDate'.
                    if (r.status === 'Open' && r.expDate < today) r.status = 'Overdue';
                    if (r.status === 'Overdue' && r.expDate >= today) r.status = 'Open'; 
                });
                
                // Refresh the current view to reflect the real-time changes
                refreshCurrentView();
            }, (error) => {
                console.error("Real-time data listener failed: ", error);
                Swal.fire('Error', 'Failed to load real-time data. Check console.', 'error');
            });
        }
        
        // Helper to refresh the current view without navigating away
        function refreshCurrentView() {
            if (currentView === 'dashboard') loadDashboardMetrics();
            else if (currentView === 'analytics') loadDashboardMetrics(true);
            else if (['pending', 'total', 'overdue'].includes(currentView)) filterList(false);
            else if (currentView === 'return') filterReturnList();
            else if (currentView === 'extend') filterExtendList();
        }

        // MODIFICATION: fetchAllRgps now returns the globally maintained rgpRecords
        async function fetchAllRgps() {
            // Data is kept up-to-date by the real-time listener (startRealtimeListener)
            // No need to manually fetch data from Firestore here unless the listener fails.
            // We only need to ensure data is available.
            if (rgpRecords.length === 0) {
                 // Fallback/Initial load check, although listener should populate it
                 loadRgpsFromLocalStorage(); // Fallback to local storage (empty array now)
            }
            // Recalculate Overdue status (logic retained from original)
            const today = new Date().toISOString().split('T')[0];
            rgpRecords.forEach(r => {
                if (r.status === 'Open' && r.expDate < today) r.status = 'Overdue';
                if (r.status === 'Overdue' && r.expDate >= today) r.status = 'Open'; 
            });
            return rgpRecords;
        }


        // --- NAVIGATION & HEADER ---
        window.navigateTo = (viewName, filterOverride = null) => {
            // MODIFICATION: Manager guard for restricted views
            if (currentUserRole === 'manager' && (viewName === 'create' || viewName === 'return' || viewName === 'extend')) {
                Swal.fire('Access Denied', 'Managers cannot perform RGP creation, return, or extension operations.', 'warning');
                return;
            }
            
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            
            let targetViewId;
            if (viewName === 'return') {
                 targetViewId = 'view-return';
            } else {
                targetViewId = ['pending','total','overdue'].includes(viewName) ? 'view-list' : 'view-' + viewName;
            }
            
            const target = document.getElementById(targetViewId);
            
            if(target) {
                target.style.display = 'block';
                setTimeout(() => target.classList.add('active'), 10);
            }

            const titleEl = document.getElementById('header-title');
            const backBtn = document.getElementById('btn-home');
            
            currentView = viewName; // Update global currentView
            
            if(viewName === 'dashboard') {
                titleEl.innerText = 'RGP DASHBOARD';
                backBtn.style.display = 'none';
            } else {
                backBtn.style.display = 'block';
                const titles = {
                    'create': 'Create New RGP',
                    'return': 'Return Entry',
                    'pending': 'Pending List',
                    'extend': 'Extend RGP',
                    'total': 'Total RGP List',
                    'analytics': 'Analytics Dashboard',
                    'overdue': 'Overdue List'
                };
                titleEl.innerText = titles[viewName] ? titles[viewName].toUpperCase() : viewName.toUpperCase();
            }

            if (viewName === 'create') setupCreateForm();
            if (viewName === 'return') loadReturnPage(filterOverride); 
            if (viewName === 'dashboard') loadDashboardMetrics();
            if (viewName === 'analytics') loadDashboardMetrics(true);
            
            if (['pending', 'total', 'overdue'].includes(viewName)) {
                loadListPage(viewName, filterOverride);
            }
            
            if (viewName === 'extend') loadExtendPage();
        };

        window.goHome = () => {
            loadDashboardMetrics();
            window.navigateTo('dashboard');
        };

        // --- CREATE RGP ---
        function setupCreateForm() {
            const today = new Date();
            // FIX 3: RGP Date field now allows input but pre-loads current date
            document.getElementById('rgpDate').valueAsDate = today; 
            
            const expDate = new Date();
            expDate.setDate(today.getDate() + 30);
            document.getElementById('expDate').valueAsDate = expDate;
            document.getElementById('expDate').min = today.toISOString().split("T")[0]; // Cannot set return date before today
            generateItemRows();
        }

        // MODIFICATION: Item row generation logic is correct and retained.
        function generateItemRows() {
            const count = parseInt(document.getElementById('itemCount').value) || 1;
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                container.innerHTML += `<tr>
                    <td><input type="text" class="form-control item-desc" required></td>
                    <td><input type="number" class="form-control item-qty" min="1" value="1" required></td>
                </tr>`;
            }
        }
        
        // MODIFICATION: Updated RGP creation to use Firestore's addDoc
        document.getElementById('createRgpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (currentUserRole === 'manager') {
                 return Swal.fire('Access Denied', 'Managers cannot create RGPs.', 'warning');
            }
            
            const items = [];
            document.querySelectorAll('#itemsContainer tr').forEach(r => {
                items.push({
                    desc: r.querySelector('.item-desc').value,
                    qty: parseInt(r.querySelector('.item-qty').value),
                    returned: 0
                });
            });

            const rgpData = {
                // MODIFICATION: Removed manual ID generation, Firestore handles this
                rgpNo: document.getElementById('rgpNo').value,
                rgpDate: document.getElementById('rgpDate').value,
                expDate: document.getElementById('expDate').value,
                sentBy: document.getElementById('sentBy').value,
                vendor: document.getElementById('vendor').value,
                items: items,
                status: 'Open',
                createdAt: new Date().toISOString(),
                extensions: 0 
            };

            try {
                if(db) {
                     // Firestore Save Logic
                    await addDoc(collection(db, "rgps"), rgpData);
                } else {
                    // Fallback to local storage (retained)
                    rgpData.id = `RGP_${rgpIdCounter++}`; 
                    rgpRecords.push(rgpData);
                    saveRgpsToLocalStorage();
                }

                document.getElementById('createRgpForm').reset();
                generateItemRows();
                showSuccessToast('RGP Created Successfully!');
                // Data listener will handle loadDashboardMetrics/navigateTo('dashboard') via refreshCurrentView()
                navigateTo('dashboard'); 
            } catch (err) { 
                console.error("RGP Save Error:", err);
                Swal.fire('Error', 'Save Error: ' + err.message, 'error'); 
            }
        });


        // --- LIST PAGES & FILTERS ---
        
        async function loadListPage(type, filterOverride = null) {
            currentView = type;
            await fetchAllRgps(); // This now returns the real-time data
            
            const statusDiv = document.getElementById('statusFilterDiv');
            
            // Reset filters and search
            document.getElementById('listSearch').value = '';
            document.getElementById('statusFilter').value = '';
            statusDiv.style.display = (type === 'total') ? 'block' : 'none';

            // Apply filter override from dashboard tiles
            if (filterOverride === 'Closed') {
                 document.getElementById('statusFilter').value = 'Closed';
            }
            
            filterList(false); 
        }
        
        /**
         * Renders the list table with the new column order and in-line details.
         * FIX 2: Includes 'Exp. Return Date' column.
         */
        function renderTable(data, tbodyId, viewContext) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                // Adjust colspan for the 11 columns (now RGP No + RGP Date + Material + Sent By + Vendor + Exp Date + 3 Qty + Status + Action)
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No Records Found</td></tr>';
                return;
            }
            
            const isStaff = currentUserRole === 'staff';

            data.forEach(r => {
                // Material Data Aggregation (Stacking)
                const materials = r.items.map(item => item.desc).join('<br>');
                const initialQtys = r.items.map(item => item.qty).join('<br>');
                const returnedQtys = r.items.map(item => item.returned || 0).join('<br>');
                
                const remainingQtys = r.items.map(item => {
                    const remaining = item.qty - (item.returned || 0);
                    const color = remaining > 0 ? 'text-danger fw-bold' : 'text-success';
                    return `<span class="${color}">${remaining}</span>`;
                }).join('<br>');
                
                // Determine if there is any remaining quantity across all items
                const totalRemainingQty = r.items.reduce((sum, item) => sum + (item.qty - (item.returned || 0)), 0);

                let actionHtml = '';
                if (viewContext === 'extend' && isStaff) {
                    // Only show the dedicated Extend button for Open/Overdue RGPs in the Extend list and for staff
                    if (r.status === 'Open' || r.status === 'Overdue') {
                        actionHtml = `<button class="btn btn-sm btn-info text-white w-100" onclick="selectForExtend('${r.id}', '${r.rgpNo}')">Extend</button>`;
                    } else {
                        actionHtml = `<span class="text-success small">Closed</span>`;
                    }
                } else if (viewContext === 'return' && isStaff) {
                     // In the return list, the action button initiates the return form and for staff
                    if (totalRemainingQty > 0) {
                        actionHtml = `<button class="btn btn-sm btn-primary w-100" onclick="selectForReturn('${r.id}')">Return Now</button>`;
                    } else {
                        actionHtml = `<span class="text-success small">Fully Returned</span>`;
                    }
                } else {
                     // Default for other lists (Pending/Total/Overdue) - No explicit button in column, row click handles it
                    actionHtml = `<button class="btn btn-sm btn-secondary w-100 disabled">Details</button>`;
                }
                
                // Construct the row with the new column order including Exp. Return Date
                tbody.innerHTML += `<tr onclick="showActionModal('${r.id}')">
                    <td class="rgp-no-col fw-bold">${r.rgpNo}</td>
                    <td class="date-col">${formatDate(r.rgpDate)}</td>
                    <td class="item-list-cell details-col">${materials}</td>
                    <td class="vendor-col">${r.sentBy}</td>
                    <td class="vendor-col">${r.vendor}</td>
                    <td class="exp-date-col">${formatDate(r.expDate)}</td> <td class="qty-cell qty-col">${initialQtys}</td>
                    <td class="qty-cell qty-col">${returnedQtys}</td>
                    <td class="qty-cell qty-col">${remainingQtys}</td>
                    <td><span class="status-badge status-${r.status}">${r.status}</span></td>
                    <td class="action-col">${actionHtml}</td>
                </tr>`;
            });
        }


        window.filterList = (refetch = true) => {
            if(refetch) fetchAllRgps(); 
            
            const term = document.getElementById('listSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            // MODIFICATION: Use rgpRecords
            let res = rgpRecords;
            
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            if (currentView === 'pending') {
                res = res.filter(r => r.status === 'Open' || r.status === 'Overdue');
            } else if (currentView === 'overdue') {
                // Overdue logic: Expired date OR 30+ days old RGP date (and not Closed)
                res = res.filter(r => {
                    if (r.status === 'Closed') return false; 

                    const isPastExpDate = new Date(r.expDate) < today;
                    const isOver30DaysOld = new Date(r.rgpDate) < thirtyDaysAgo;
                    
                    return isPastExpDate || isOver30DaysOld;
                });
            } else if (statusFilter !== '') {
                res = res.filter(r => r.status === statusFilter);
            }

            // Text search
            res = res.filter(r => {
                const matchesRgpProps = r.rgpNo.toLowerCase().includes(term) || r.vendor.toLowerCase().includes(term) || r.sentBy.toLowerCase().includes(term) || formatDate(r.rgpDate).includes(term) || formatDate(r.expDate).includes(term);
                const matchesItemDesc = r.items.some(item => item.desc.toLowerCase().includes(term));
                return (matchesRgpProps || matchesItemDesc);
            });
            
            renderTable(res, 'listBody', currentView);
        };
        
        window.resetListFilters = () => {
            document.getElementById('listSearch').value = '';
            document.getElementById('statusFilter').value = '';
            filterList();
        }
        
        // --- ACTION MODAL ---
        // MODIFICATION: Added logic to disable action buttons for manager in the modal
        window.showActionModal = (rgpId) => {
            const rgp = findRgpById(rgpId);
            if (!rgp) return;

            // Fill Header Info
            document.getElementById('modalRgpNo').innerText = rgp.rgpNo;
            document.getElementById('modalRgpDate').innerText = formatDate(rgp.rgpDate);
            document.getElementById('modalExpDate').innerText = formatDate(rgp.expDate);
            document.getElementById('modalStatus').innerHTML = `<span class="status-badge status-${rgp.status}">${rgp.status}</span>`;
            document.getElementById('modalVendor').innerText = rgp.vendor;
            document.getElementById('modalSentBy').innerText = rgp.sentBy;

            // Fill Item Details
            const tbody = document.getElementById('modalItemsBody');
            tbody.innerHTML = '';
            let outstandingItems = false;
            
            rgp.items.forEach(item => {
                const remaining = item.qty - (item.returned || 0);
                if (remaining > 0) outstandingItems = true;
                tbody.innerHTML += `<tr>
                    <td>${item.desc}</td>
                    <td>${item.qty}</td>
                    <td>${item.returned || 0}</td>
                    <td><span class="text-${remaining > 0 ? 'danger' : 'success'}">${remaining}</span></td>
                </tr>`;
            });
            
            // Set Modal Actions
            const btnExtend = document.getElementById('btnExtendModal');
            const btnReturn = document.getElementById('btnReturnModal');
            
            btnExtend.dataset.rgpId = rgpId;
            btnExtend.dataset.rgpNo = rgp.rgpNo;
            btnReturn.dataset.rgpId = rgpId;

            // Enable/Disable buttons based on status AND user role
            const isOpen = rgp.status === 'Open' || rgp.status === 'Overdue';
            const isStaff = currentUserRole === 'staff';
            
            btnExtend.disabled = !isOpen || !isStaff; 
            btnReturn.disabled = !isOpen || !outstandingItems || !isStaff;

            if (rgp.status === 'Closed') {
                 btnExtend.disabled = true; 
                 btnReturn.disabled = true;
            }

            // Show modal
            const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
            actionModal.show();
        };

        // --- EXTEND LOGIC ---
        window.promptExtension = (rgpId, rgpNo) => {
             // Hide the detail modal first
            const actionModal = bootstrap.Modal.getInstance(document.getElementById('actionModal'));
            if(actionModal) actionModal.hide();
            
            // Navigate to extend page and select the item
            navigateTo('extend');
            setTimeout(() => {
                selectForExtend(rgpId, rgpNo);
            }, 100);
        };
        
        async function loadExtendPage() {
            currentView = 'extend'; 
            document.getElementById('extendFormArea').style.display = 'none';
            document.getElementById('extendSearchRgp').value = '';
            await fetchAllRgps();
            filterExtendList(); 
        }
        
        window.filterExtendList = () => {
            const term = document.getElementById('extendSearchRgp').value.toLowerCase();
            // MODIFICATION: Use rgpRecords
            const openRgps = rgpRecords.filter(r => (r.status === 'Open' || r.status === 'Overdue'));

            const filteredRgps = openRgps.filter(r => {
                const matchesRgpProps = r.rgpNo.toLowerCase().includes(term) || 
                                        r.vendor.toLowerCase().includes(term) || 
                                        r.sentBy.toLowerCase().includes(term) ||
                                        formatDate(r.rgpDate).includes(term) || 
                                        formatDate(r.expDate).includes(term);
                const matchesItemDesc = r.items.some(item => item.desc.toLowerCase().includes(term));
                return matchesRgpProps || matchesItemDesc;
            });
            
            renderTable(filteredRgps, 'extendListBody', 'extend');
        };

        window.selectForExtend = (id, no) => {
            // MODIFICATION: Manager guard
            if (currentUserRole === 'manager') {
                 return Swal.fire('Access Denied', 'Managers cannot extend RGPs.', 'warning');
            }
            
            document.getElementById('extendFormArea').style.display = 'block';
            document.getElementById('extendRgpId').innerText = no;
            document.getElementById('extendFormArea').dataset.id = id;
            
            const rgp = findRgpById(id);
            if(rgp) document.getElementById('newExtendDate').value = rgp.expDate;
            document.getElementById('extendFormArea').scrollIntoView({ behavior: 'smooth' });
        };

        // MODIFICATION: Updated RGP extension to use Firestore's updateDoc
        window.submitExtension = async () => {
            const docId = document.getElementById('extendFormArea').dataset.id;
            const newDate = document.getElementById('newExtendDate').value;
            const reason = document.getElementById('extendReason').value;

            if(!newDate || !reason) return Swal.fire('Warning', 'Fill all fields', 'warning');
            
            if (currentUserRole === 'manager') {
                 return Swal.fire('Access Denied', 'Managers cannot update RGP entries.', 'warning');
            }

            try {
                const rgp = findRgpById(docId);
                if (!rgp) throw new Error("RGP not found for ID: " + docId);
                
                const updateData = {
                    expDate: newDate,
                    status: 'Open', 
                    extensionReason: reason,
                    extensions: (rgp.extensions || 0) + 1 
                };
                
                if(db) {
                     // Firestore Update Logic
                    const rgpRef = doc(db, "rgps", docId);
                    await updateDoc(rgpRef, updateData);
                } else {
                    // Local Storage Update Logic (Retained)
                    const rgpIndex = rgpRecords.findIndex(r => r.id === docId);
                    if(rgpIndex !== -1) {
                        rgpRecords[rgpIndex] = {...rgpRecords[rgpIndex], ...updateData};
                        saveRgpsToLocalStorage();
                    }
                }

                Swal.fire('Success', 'Extension Updated', 'success');
                // Real-time listener handles loadExtendPage()
            } catch (err) {
                 console.error("Extension Save Error:", err);
                 Swal.fire('Error', 'Extension Update Error: ' + err.message, 'error');
            }
        }

        // --- RETURN LOGIC ---
        window.navigateToReturn = (rgpId) => {
             // Hide the detail modal first
            const actionModal = bootstrap.Modal.getInstance(document.getElementById('actionModal'));
            if(actionModal) actionModal.hide();
            
            // Navigate to return page and select the item
            navigateTo('return');
            setTimeout(() => {
                // Pre-select the RGP if an ID was passed
                if(rgpId) selectForReturn(rgpId);
            }, 100);
        }
        
        async function loadReturnPage(rgpId = null) {
            currentView = 'return'; 
            document.getElementById('returnEntryArea').style.display = 'none';
            document.getElementById('returnSearchRgp').value = '';
            await fetchAllRgps();
            filterReturnList(); 
            if(rgpId) {
                // Pre-select the RGP if navigating from the modal
                selectForReturn(rgpId);
            }
        }
        
        // Filter and render the return list using standard table format
        window.filterReturnList = () => {
            const term = document.getElementById('returnSearchRgp').value.toLowerCase();
            // MODIFICATION: Use rgpRecords
            const open = rgpRecords.filter(r => (r.status === 'Open' || r.status === 'Overdue'));

            const filteredRgps = open.filter(r => {
                const matchesRgpProps = r.rgpNo.toLowerCase().includes(term) || 
                                        r.vendor.toLowerCase().includes(term) || 
                                        r.sentBy.toLowerCase().includes(term) ||
                                        formatDate(r.rgpDate).includes(term) || 
                                        formatDate(r.expDate).includes(term);
                
                const matchesItemDesc = r.items.some(item => item.desc.toLowerCase().includes(term));
                
                return matchesRgpProps || matchesItemDesc;
            });
            
            renderTable(filteredRgps, 'returnListBody', 'return');
        };

        window.selectForReturn = (id) => {
            // MODIFICATION: Manager guard
            if (currentUserRole === 'manager') {
                 return Swal.fire('Access Denied', 'Managers cannot enter return quantities.', 'warning');
            }
            
            const rgp = findRgpById(id);
            if (!rgp) return;

            document.getElementById('returnEntryArea').style.display = 'block';
            document.getElementById('returnEntryArea').dataset.id = rgp.id;
            document.getElementById('returnRgpHeader').innerText = `RGP: ${rgp.rgpNo} (Vendor: ${rgp.vendor})`;
            
            const tbody = document.getElementById('returnItemsBody');
            tbody.innerHTML = '';
            
            let allItemsReturned = true;
            rgp.items.forEach((item, idx) => {
                const outstanding = item.qty - (item.returned || 0);
                const isDisabled = outstanding === 0;
                
                if (!isDisabled) allItemsReturned = false;

                tbody.innerHTML += `<tr>
                    <td>${item.desc}</td><td>${item.qty}</td><td>${item.returned || 0}</td><td class="fw-bold text-${outstanding > 0 ? 'danger' : 'success'}">${outstanding}</td>
                    <td><input type="number" class="form-control return-input" data-idx="${idx}" max="${outstanding}" min="0" value="${isDisabled ? 0 : outstanding}" ${isDisabled ? 'disabled' : ''}></td>
                </tr>`;
            });
            
            document.getElementById('returnEntryArea').scrollIntoView({ behavior: 'smooth' });

            if (allItemsReturned) {
                 Swal.fire('Info', `RGP ${rgp.rgpNo} is already fully returned/closed.`, 'info');
            }
        };


        // MODIFICATION: Updated return entry to use Firestore's updateDoc
        window.submitReturn = async () => {
            const rgpId = document.getElementById('returnEntryArea').dataset.id;
            const inputs = document.querySelectorAll('#returnItemsBody .return-input');
            
            if (currentUserRole === 'manager') {
                 return Swal.fire('Access Denied', 'Managers cannot update RGP entries.', 'warning');
            }
            
            const rgp = findRgpById(rgpId);
            if (!rgp) { return Swal.fire('Error', 'RGP not found.', 'error'); }

            let fullReturn = true;
            let totalReturnedNow = 0;
            // Deep copy items to avoid modifying the real-time array before successful save
            let updatedItems = JSON.parse(JSON.stringify(rgp.items));

            // Validate and calculate updates
            for (const input of inputs) {
                const val = parseInt(input.value) || 0;
                const idx = parseInt(input.dataset.idx);
                const max = parseInt(input.max);
                
                if (val < 0 || val > max) {
                    return Swal.fire('Error', `Invalid return quantity entered for item ${updatedItems[idx].desc}. Max is ${max}.`, 'error');
                }

                if (val > 0) totalReturnedNow += val;
                
                updatedItems[idx].returned = (updatedItems[idx].returned || 0) + val;
                if (updatedItems[idx].returned < updatedItems[idx].qty) fullReturn = false;
            }

            if (totalReturnedNow === 0) {
                 return Swal.fire('Warning', 'Please enter a quantity to return.', 'warning');
            }

            const newStatus = fullReturn ? 'Closed' : 'Open';
            
            try {
                if(db) {
                    // Firestore Update Logic
                    const rgpRef = doc(db, "rgps", rgpId);
                    await updateDoc(rgpRef, {
                        items: updatedItems,
                        status: newStatus
                    });
                } else {
                     // Local Storage Update Logic (Retained)
                     const rgpIndex = rgpRecords.findIndex(r => r.id === rgpId);
                     rgpRecords[rgpIndex].items = updatedItems;
                     rgpRecords[rgpIndex].status = newStatus;
                     saveRgpsToLocalStorage();
                }

                showSuccessToast('Return Entry Saved!');
                // Real-time listener handles loadReturnPage()
            } catch (err) {
                 console.error("Return Save Error:", err);
                 Swal.fire('Error', 'Return Update Error: ' + err.message, 'error');
            }
        };

        // --- DASHBOARD & ANALYTICS GRAPHS AND WIDGETS ---
        async function loadDashboardMetrics(isFullAnalytics = false) {
            // MODIFICATION: Use rgpRecords
            const data = rgpRecords; // Data is already loaded/updated by listener

            // --- 1. Update Metric Tiles ---
            document.getElementById('metric-total').innerText = data.length;
            document.getElementById('metric-open').innerText = data.filter(r => r.status === 'Open').length;
            document.getElementById('metric-closed').innerText = data.filter(r => r.status === 'Closed').length;
            
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            const overdueRgps = data.filter(r => {
                if (r.status === 'Closed') return false;
                return new Date(r.expDate) < today || new Date(r.rgpDate) < thirtyDaysAgo;
            });
            document.getElementById('metric-overdue').innerText = overdueRgps.length;
            
            const openRgps = data.filter(r => r.status === 'Open' || r.status === 'Overdue');
            
            // --- 2. Analytics Widgets (Full Analytics Page) ---
            if (isFullAnalytics) {
                let totalItems = 0;
                let outstandingItems = 0;
                let totalCycleTime = 0;
                let closedRgpCount = 0;
                let maxExtensionsRgpNo = 'N/A';
                let maxExtensionsCount = -1;

                data.forEach(rgp => {
                    // Item counts
                    rgp.items.forEach(item => {
                        totalItems += item.qty;
                        outstandingItems += (item.qty - (item.returned || 0));
                    });
                    
                    // Cycle Time
                    if (rgp.status === 'Closed') {
                        const rgpDate = new Date(rgp.rgpDate);
                        // Using the last return date or rgp date if no return info is logged
                        const closedDate = new Date(rgp.expDate); // Simplification: Assume closure date is expDate for cycle time calc
                        const diffTime = Math.abs(closedDate - rgpDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        totalCycleTime += diffDays;
                        closedRgpCount++;
                    }

                    // Max Extensions
                    if (rgp.extensions > maxExtensionsCount) {
                        maxExtensionsCount = rgp.extensions;
                        maxExtensionsRgpNo = `${rgp.rgpNo} (${rgp.extensions})`;
                    }
                });

                document.getElementById('widget-total-items').innerText = totalItems.toLocaleString();
                document.getElementById('widget-outstanding-items').innerText = outstandingItems.toLocaleString();
                document.getElementById('widget-avg-cycle').innerText = closedRgpCount > 0 ? Math.round(totalCycleTime / closedRgpCount) : 'N/A';
                document.getElementById('widget-max-extension').innerText = maxExtensionsRgpNo;
                
                // --- 4. Render Full Charts ---
                const vendorCounts = {};
                openRgps.forEach(r => { vendorCounts[r.vendor] = (vendorCounts[r.vendor]||0) + 1 });
                const sortedVendors = Object.entries(vendorCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);

                const userCounts = {};
                openRgps.forEach(r => { userCounts[r.sentBy] = (userCounts[r.sentBy]||0) + 1 });
                const sortedUsers = Object.entries(userCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
                
                const statusCounts = data.reduce((acc, r) => {
                    acc[r.status] = (acc[r.status] || 0) + 1;
                    return acc;
                }, {});

                const dateCounts = data.reduce((acc, r) => {
                    const monthYear = r.rgpDate.substring(0, 7);
                    acc[monthYear] = (acc[monthYear] || 0) + 1;
                    return acc;
                }, {});
                const sortedDateCounts = Object.entries(dateCounts).sort((a,b) => a[0].localeCompare(b[0]));
                
                renderPieChart('chartStatus', statusCounts);
                renderLineChart('chartDateDistribution', sortedDateCounts);
                renderBarChart('chartVendorFull', sortedVendors, 'Vendor', '#D21F3C', 'y', 'pending');
                renderBarChart('chartSentByFull', sortedUsers, 'User', '#005596', 'y', 'pending');
            }
            
            // --- 3. Render Dashboard Charts (always run) ---
            const vendorCounts = {};
            openRgps.forEach(r => { vendorCounts[r.vendor] = (vendorCounts[r.vendor]||0) + 1 });
            const sortedVendors = Object.entries(vendorCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);

            const userCounts = {};
            openRgps.forEach(r => { userCounts[r.sentBy] = (userCounts[r.sentBy]||0) + 1 });
            const sortedUsers = Object.entries(userCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            
            renderBarChart('chartVendor', sortedVendors, 'Vendor', '#D21F3C', 'y', 'pending');
            renderBarChart('chartSentBy', sortedUsers, 'User', '#005596', 'y', 'pending');
        }
        
        // --- CHART GENERATION FUNCTIONS (Modified with maintainAspectRatio: false) ---
        const destroyChart = (id) => {
            if (chartInstances[id]) {
                chartInstances[id].destroy();
                delete chartInstances[id];
            }
        };

        function renderBarChart(id, data, label, color, axis, viewToNavigate) {
            destroyChart(id);
            const labels = data.map(item => item[0]);
            const counts = data.map(item => item[1]);
            
            const ctx = document.getElementById(id);
            if (!ctx) return; 

            chartInstances[id] = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: `Open RGPs by ${label}`, 
                        data: counts, 
                        backgroundColor: color, 
                        borderColor: color,
                        borderWidth: 1
                    }] 
                },
                options: {
                    indexAxis: axis, 
                    responsive: true,
                    // Crucial setting to prevent stretching inside the fixed-height container
                    maintainAspectRatio: false, 
                    scales: { x: { beginAtZero: true } },
                    plugins: { legend: { display: false } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const filterValue = labels[index];
                            navigateTo(viewToNavigate); 
                            setTimeout(() => {
                                document.getElementById('listSearch').value = filterValue;
                                filterList();
                            }, 100);
                        }
                    }
                }
            });
        }
        
        function renderPieChart(id, statusCounts) {
            destroyChart(id);
            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            
            const ctx = document.getElementById(id);
            if (!ctx) return;

            chartInstances[id] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#28a745', '#ffc107', '#D21F3C'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    // Crucial setting to prevent stretching inside the fixed-height container
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: { position: 'right' },
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const status = labels[index];
                            navigateTo('total'); 
                            setTimeout(() => {
                                document.getElementById('statusFilter').value = status;
                                filterList();
                            }, 100);
                        }
                    }
                }
            });
        }
        
        function renderLineChart(id, dateData) {
            destroyChart(id);
            const labels = dateData.map(item => item[0]);
            const data = dateData.map(item => item[1]);
            
            const ctx = document.getElementById(id);
            if (!ctx) return;

            chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'RGP Creations',
                        data: data,
                        backgroundColor: 'rgba(0, 85, 150, 0.2)',
                        borderColor: '#005596',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    // Crucial setting to prevent stretching inside the fixed-height container
                    maintainAspectRatio: false, 
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }


        window.exportTableToExcel = (tableId, filename) => {
            const table = document.getElementById(tableId);
            const wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
            XLSX.writeFile(wb, filename + '.xlsx');
        };
        
        // Initial load
        window.onload = () => {
            loadRgpsFromLocalStorage(); // Initial sync of local structure
            
            if (document.getElementById('app-container').style.display !== 'flex') {
                document.getElementById('login-screen').style.display = 'flex';
            } else {
                goHome(); // Should not happen in a typical browser load flow, but retained.
            }
        };
    </script>
</body>
</html>