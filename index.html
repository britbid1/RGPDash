<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGP Manager Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> 
    <style>
        /* Custom Styles for Button Colors to mimic the PySide6 app */
        .btn-new-rgp { background-color: #4f46e5; } /* Indigo */
        .btn-new-rgp:hover { background-color: #4338ca; }

        .btn-return { background-color: #10b981; } /* Green */
        .btn-return:hover { background-color: #059669; }

        .btn-pending { background-color: #f59e0b; } /* Orange */
        .btn-pending:hover { background-color: #d97706; }

        .btn-total { background-color: #3b82f6; } /* Blue */
        .btn-total:hover { background-color: #2563eb; }

        .btn-analytics { background-color: #8b5cf6; } /* Purple */
        .btn-analytics:hover { background-color: #7c3aed; }
        
        /* NEW STYLE FOR APPROVAL BUTTON */
        .btn-approval { background-color: #06b6d4; } /* Cyan */
        .btn-approval:hover { background-color: #0891b2; }

        .metric-box-base {
            background-color: #f9fafb; 
            border: 1px solid #e5e7eb;
        }

        .metric-box-overdue {
            background-color: #fee2e2; 
            border: 1px solid #fca5a5;
        }

        /* Styles for Bar Charts (Vendors/Users) */
        .vendor-bar-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .vendor-label {
            flex-basis: 120px;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .vendor-bar {
            height: 20px;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        .vendor-count {
            font-weight: bold;
            flex-shrink: 0;
            min-width: 20px;
            text-align: right;
        }

        /* Custom scrollbar for table */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading-spinner" class="text-center mt-20">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Loading application...</p>
    </div>

    <div id="main-content" class="container mx-auto hidden">
        <div id="message-container" class="fixed bottom-4 left-4 z-50 w-80"></div>
    </div>

    <script type="module">
        // Removed all Firebase imports as the backend is now Google Apps Script
        
        // --- GOOGLE APPS SCRIPT CONFIGURATION ---
        const APPS_SCRIPT_URL = 'https://script.google.com/a/macros/britindia.com/s/AKfycbz3OTGDmRT7x83v9WvLqSToRWFUlHK1QZWCWm5ayp7zd9Q7wkTBzNOL0ZGZXjLI_URC-A/exec';
        const PRIMARY_DB_NAME = 'RGP_Database'; 
        const BACKUP_DB_NAME = 'RGP_DB_Backup'; 

        // --- GLOBAL STATE ---
        let currentPage = 'dashboard';
        let pageHistory = [];
        let selectedRGP = null;
        let selectedRGPNumber = null;
        let pendingRGPData = []; // Store the full list of OPEN RGPs
        let filteredRGPData = []; // Store the list currently shown in the PENDING table (used for export)

        // --- GLOBAL STATE FOR TOTAL LIST VIEW (NEW) ---
        window.totalRGPFilterText = '';
        window.totalRGPStatusFilter = 'ALL';
        window.filteredTotalRGPData = [];
        window.totalRGPOverdueFilter = false; 
        // NEW: Analytics Filter State
        window.analyticsFilterType = null; 
        window.analyticsFilterValue = null; 
        
        // --- GLOBAL STATE FOR APPROVAL LIST VIEW (NEW) ---
        window.approvalRGPData = []; 
        window.filteredApprovalRGPData = []; 
        
        // --- PERSISTENT DATA STATE ---
        let currentRGPData = []; // Live data from Google Sheet

        /**
         * Converts the expected_return_date string to a Date object.
         * @param {string} dateStr - Date string in YYYY-MM-DD format.
         * @returns {Date}
         */
        function parseDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            // Months in JS are 0-indexed, so subtract 1
            return new Date(year, month - 1, day);
        }
        
        /**
         * Formats a Date object to YYYY-MM-DD string (for internal data & HTML inputs).
         * @param {Date} date - The date object.
         * @returns {string} YYYY-MM-DD
         */
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        /**
         * Formats a YYYY-MM-DD date string to DD/MM/YYYY string for display in lists.
         * @param {string} dateStr - Date string in YYYY-MM-DD format.
         * @returns {string} DD/MM/YYYY
         */
        function formatDateDisplay(dateStr) {
            if (!dateStr || dateStr.length !== 10) return dateStr;
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        /**
         * Adds days to a date and returns the YYYY-MM-DD string.
         * @param {number} days - Number of days to add.
         * @returns {string} YYYY-MM-DD
         */
        function dateOffset(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return formatDate(date);
        }

        // --- RGP MANAGER FUNCTIONS (UNCHANGED LOGIC) ---
        const RGPManager = {
            get_total_rgps: (data) => data.length,
            get_open_rgps: (data) => data.filter(r => r.status.toUpperCase() === "OPEN").length,
            get_closed_rgps: (data) => data.filter(r => r.status.toUpperCase() === "CLOSED").length,
            
            get_overdue_rgps: (data) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                return data.filter(r => {
                    if (r.status.toUpperCase() !== "OPEN" || !r.expected_return_date) return false;

                    try {
                        const expectedReturnDate = parseDate(r.expected_return_date);
                        // RGP is considered overdue if it's 30 days past the expected return date.
                        const thirtyDaysAfterReturn = new Date(expectedReturnDate);
                        thirtyDaysAfterReturn.setDate(expectedReturnDate.getDate() + 30);
                        
                        return today > thirtyDaysAfterReturn;

                    } catch (e) {
                        console.error("Date parsing error for RGP:", r.id, e);
                        return false;
                    }
                }).length;
            },

            get_vendor_open_counts: (data) => {
                const counts = {};
                data.forEach(r => {
                    if (r.status.toUpperCase() === "OPEN") {
                        const vendor = (r.sent_to || "Unknown").trim() || "Unknown";
                        counts[vendor] = (counts[vendor] || 0) + 1;
                    }
                });
                return Object.entries(counts).sort(([, a], [, b]) => b - a);
            },
            
            // New helper function to find RGP by number (Uses Sheet ID for lookups)
            find_rgp_by_number: (rgpNumber) => {
                return currentRGPData.find(r => rgpNumber && r.rgp_number.toUpperCase() === rgpNumber.toUpperCase());
            },

            // New helper function to get open RGPs
            get_pending_rgp_data: (data) => {
                return data.filter(r => r.status.toUpperCase() === "OPEN");
            },
            
            // New helper function to get RGPs for approval list 
            get_approval_rgp_data: (data) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                return data.filter(r => {
                    if (r.status.toUpperCase() !== "OPEN") return false;
                    
                    try {
                        const issueDate = parseDate(r.issue_date);
                        
                        // 1. Check if it has exceeded the Expected Return Date
                        let isOverdue = false;
                        const expectedReturnDate = parseDate(r.expected_return_date);
                        // Is overdue if today is strictly greater than expected return date
                        isOverdue = today > expectedReturnDate; 

                        // 2. Check if it is more than 30 days old from RGP Date (Issue Date)
                        const thirtyDaysAfterIssue = new Date(issueDate);
                        thirtyDaysAfterIssue.setDate(issueDate.getDate() + 30);
                        const isThirtyDaysOld = today > thirtyDaysAfterIssue;

                        // RGP must be OPEN AND (Exceeded Expected Return Date OR 30 Days Old from Issue Date)
                        return isOverdue || isThirtyDaysOld;
                    } catch (e) {
                        console.error("Date parsing error for RGP:", r.id, e);
                        return false;
                    }
                });
            }, 

            // Helper to calculate days open
            calculate_days_open: (issueDateStr) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                try {
                    const issueDate = parseDate(issueDateStr);
                    const diffTime = Math.abs(today - issueDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays;
                } catch (e) {
                    return 'N/A';
                }
            }, 

            // --- NEW ANALYTICS FUNCTIONS FOR ANALYTICS PAGE ---
            get_avg_days_open: (data) => {
                if (data.length === 0) return 0;
                
                const totalDays = data.reduce((sum, r) => {
                    const days = RGPManager.calculate_days_open(r.issue_date);
                    return sum + (typeof days === 'number' ? days : 0);
                }, 0);

                return (totalDays / data.length).toFixed(1);
            },
            
            get_total_outstanding_qty: (data) => {
                const totalOutstanding = data.reduce((sumRgp, rgp) => {
                    const rgpOutstanding = rgp.materials.reduce((sumMat, material) => {
                        return sumMat + (material.initial_qty - material.returned_qty);
                    }, 0);
                    return sumRgp + rgpOutstanding;
                }, 0);
                return totalOutstanding;
            },

            get_user_open_counts: (data) => {
                const counts = {};
                data.forEach(r => {
                    if (r.status.toUpperCase() === "OPEN") {
                        const user = (r.sent_by || "Unknown").trim() || "Unknown";
                        counts[user] = (counts[user] || 0) + 1;
                    }
                });
                return Object.entries(counts).sort(([, a], [, b]) => b - a);
            }
        };

        // --- MESSAGE & NOTIFICATION LOGIC (NEW/REFACTORED) ---

        /**
         * Displays an error or success message at the bottom-left of the screen.
         * @param {string} title - The title of the message.
         * @param {string} message - The message content.
         * @param {boolean} isError - True for red error message, false for green success message.
         */
        function showMessage(title, message, isError = false) {
            const container = document.getElementById('message-container');
            if (!container) {
                console.error(`Message UI container missing. Title: ${title}, Message: ${message}, Error: ${isError}`);
                return;
            }
            
            // Clear any previous message
            container.innerHTML = '';
            
            const messageDiv = document.createElement('div');
            const baseClasses = "p-4 rounded-xl shadow-lg transition-opacity duration-300";
            const errorClasses = "bg-red-600 text-white font-bold border-2 border-red-800";
            const successClasses = "bg-green-600 text-white font-bold border-2 border-green-800";

            messageDiv.className = `${baseClasses} ${isError ? errorClasses : successClasses}`;
            messageDiv.innerHTML = `
                <p class="font-bold">${title}</p>
                <p class="text-sm">${message}</p>
            `;

            container.appendChild(messageDiv);
            
            // Log to console for debugging as well
            if (isError) {
                console.error(`ERROR (${title}): ${message}`);
            } else {
                console.log(`${title}: ${message}`);
            }

            // Automatically hide the message after 5 seconds
            setTimeout(() => {
                messageDiv.classList.add('opacity-0');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300); // Wait for transition to finish
            }, 5000);
        }

        // --- APPS SCRIPT COMMUNICATION CORE (NEW) ---

        /**
         * Generic function to call the Google Apps Script Web App.
         * @param {string} action - The function/endpoint to call in the script (e.g., 'fetchAllRGP', 'saveNewRGP').
         * @param {object} [data={}] - The payload data to send (for POST requests).
         * @param {string} method - 'GET' or 'POST'.
         * @returns {Promise<object>} The JSON 'data' property of the response from the Apps Script.
         */
        async function callAppsScript(action, data = {}, method = 'GET') {
            const url = new URL(APPS_SCRIPT_URL);
            url.searchParams.append('action', action);
            
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            
            if (method === 'POST') {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url.toString(), options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // The Apps Script should return { status: 'success' | 'error', message: '...', data: [...] }
                if (result.status === 'error') {
                    throw new Error(result.message || 'Apps Script returned an unknown error.');
                }

                return result.data; // Return the actual data payload

            } catch (error) {
                console.error(`Apps Script Call Failed (${action}):`, error);
                throw new Error(`Server operation failed. Please check the network or server logs. Detail: ${error.message}`);
            }
        }


        // --- DATA FETCHING (REPLACING FIREBASE) ---

        /**
         * Fetches all RGP data from the Google Sheet via Apps Script.
         * This replaces the real-time Firestore listener with a fetch-and-refresh model.
         */
        async function fetchRGPData(isInitialLoad = false) {
            if (isInitialLoad) {
                document.getElementById('loading-spinner').classList.remove('hidden');
            }
            
            try {
                // Pass DB names (though the script usually handles the primary/backup logic)
                const payload = { primary: PRIMARY_DB_NAME, backup: BACKUP_DB_NAME };
                const fetchedData = await callAppsScript('fetchAllRGP', payload, 'GET'); 

                // Process data to calculate days_open
                const processedData = fetchedData.map(data => ({
                    ...data,
                    // Assuming the script returns the unique ID (key) as 'id'
                    days_open: RGPManager.calculate_days_open(data.issue_date) 
                }));

                // Update global state
                currentRGPData = processedData;
                
                // Re-calculate derived lists
                pendingRGPData = RGPManager.get_pending_rgp_data(currentRGPData);
                window.approvalRGPData = RGPManager.get_approval_rgp_data(currentRGPData);

                // Re-render the application with the new data
                renderPage(); // Call renderPage, which will re-render the current view
                
                console.log(`RGP data fetched successfully. Total RGPs: ${currentRGPData.length}`);

            } catch (error) {
                showMessage("Data Fetch Error", `Could not load RGP data from server: ${error.message}`, true);
                currentRGPData = []; // Clear data if fetch fails
                pendingRGPData = [];
                window.approvalRGPData = [];
                renderPage(); // Render empty dashboard
            } finally {
                if (isInitialLoad) {
                    document.getElementById('loading-spinner').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                }
            }
        }


        // --- NAVIGATION LOGIC (UNCHANGED) ---

        function goHome() {
            pageHistory = [];
            switchPage('dashboard');
        }

        function goBack() {
            if (pageHistory.length > 0) {
                const previousPage = pageHistory.pop();
                switchPage(previousPage, false); // Don't add back to history
            } else {
                goHome();
            }
        }
        
        // Expose navigation functions globally for inline HTML onclick handlers
        window.goHome = goHome;
        window.goBack = goBack;

        function switchPage(pageId, recordHistory = true) {
            if (currentPage !== pageId && recordHistory) {
                pageHistory.push(currentPage);
            }
            currentPage = pageId;
            renderPage();
            
            // Clear return entry state on page switch
            if (pageId !== 'returnEntry') {
                selectedRGP = null;
                selectedRGPNumber = null;
            }
        }

        // Renamed and kept original console logging
        // NOTE: All calls to the old 'showMessage' have been replaced with the new, visible showMessage.
        // The original logic here has been moved into the refactored showMessage above.

        function renderPage() {
            const contentDiv = document.getElementById('main-content');
            contentDiv.innerHTML = '';
            
            switch (currentPage) {
                case 'dashboard':
                    renderDashboardView(currentRGPData);
                    break;
                case 'newRGP':
                    renderNewRGPView();
                    break;
                case 'returnEntry':
                    renderReturnEntryView();
                    break;
                case 'pendingList':
                    renderPendingRGPListView();
                    break;
                case 'totalList':
                    renderTotalRGPListView();
                    break;
                case 'approvalList': 
                    renderApprovalRGPListView();
                    break; 
                case 'analytics': 
                    renderAnalyticsView(currentRGPData);
                    break;
                default:
                    renderDashboardView(currentRGPData);
            }
        }

        
        function handleButtonClick(action) {
            if (action === "New RGP Entry") {
                switchPage('newRGP');
            } else if (action === "Return Entry") {
                switchPage('returnEntry');
            } else if (action === "Pending RGP List") {
                // pendingRGPData is already updated by the data fetcher
                filteredRGPData = [...pendingRGPData];
                switchPage('pendingList'); 
            } else if (action === "Total RGP List") {
                 // Initialize state for Total List View (clear special filters)
                window.totalRGPFilterText = '';
                window.totalRGPStatusFilter = 'ALL';
                window.totalRGPOverdueFilter = false; 
                window.analyticsFilterType = null; // Clear analytics filter
                window.analyticsFilterValue = null; // Clear analytics filter
                // Initially, filtered data is all data
                window.filteredTotalRGPData = [...currentRGPData]; 
                switchPage('totalList');
            } else if (action === "Export Pending RGP List for Approval") { 
                 // approvalRGPData is already updated by the data fetcher
                 window.filteredApprovalRGPData = [...window.approvalRGPData];
                 switchPage('approvalList');
            } else if (action === "Analytics") { 
                switchPage('analytics');
            } else {
                showMessage("Navigation", `Navigating to ${action} functionality. (Placeholder)`);
            }
        }


        // --- DASHBOARD VIEW RENDERING (UNCHANGED) ---

        function renderDashboardView(data) {
            const contentDiv = document.getElementById('main-content');
            contentDiv.innerHTML = `
                <div id="dashboard-content">
                    <header class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                        <h1 class="text-2xl font-extrabold text-blue-600 justify-self-start">RGP Dashboard</h1>
                        <div class="justify-self-center">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain">
                        </div>
                        <div class="justify-self-end">
                            <span class="text-sm font-medium text-gray-500 hidden md:inline">V2.6.7</span>
                        </div>
                    </header>

                    <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">

                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg h-full">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Navigation & Quick Actions</h2>
                            <div id="navigation-panel" class="grid grid-cols-1 gap-4">
                                </div>
                        </div>

                        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4">RGP Key Metrics</h2>
                            
                            <div id="metrics-panel" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                </div>
                            
                            <h2 class="text-xl font-semibold text-gray-700 mb-4 pt-4 border-t border-gray-100">Top Vendors (Open RGPs)</h2>
                            <div id="vendor-panel" class="space-y-2">
                                </div>
                        </div>
                    </main>
                </div>
            `;
            // Call rendering functions for the inner parts
            renderNavigationButtons();
            renderAnalyticsPanel(data);
        }

        function renderNavigationButtons() {
            const buttonsData = [
                { label: "New RGP Entry", action: "New RGP Entry", className: "btn-new-rgp" },
                { label: "Return Entry", action: "Return Entry", className: "btn-return" },
                { label: "Pending RGP List", action: "Pending RGP List", className: "btn-pending" },
                { label: "Total RGP List", action: "Total RGP List", className: "btn-total" },
                { label: "Analytics", action: "Analytics", className: "btn-analytics" },
                { label: "Export Pending RGP List for Approval", action: "Export Pending RGP List for Approval", className: "btn-approval" } 
            ];

            const container = document.getElementById('navigation-panel');
            container.innerHTML = ''; 

            buttonsData.forEach(data => {
                const btn = document.createElement('button');
                btn.className = `${data.className} w-full text-white font-bold py-4 px-4 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01]`;
                btn.textContent = data.label;
                btn.onclick = () => handleButtonClick(data.action);
                container.appendChild(btn);
            });
        }

        function renderAnalyticsPanel(data) {
            const total = RGPManager.get_total_rgps(data);
            const open_rgps = RGPManager.get_open_rgps(data);
            const closed = RGPManager.get_closed_rgps(data);
            const overdue = RGPManager.get_overdue_rgps(data);
            const vendorCounts = RGPManager.get_vendor_open_counts(data);

            const metricsContainer = document.getElementById('metrics-panel');
            metricsContainer.innerHTML = '';

            const metrics = [
                { title: "Total RGPs", value: total, color: "text-blue-600", boxClass: "metric-box-base", action: "navigateToTotalRGPList('ALL')" },
                { title: "Open RGPs", value: open_rgps, color: "text-orange-500", boxClass: "metric-box-base", action: "navigateToTotalRGPList('OPEN')" },
                { title: "Closed RGPs", value: closed, color: "text-green-600", boxClass: "metric-box-base", action: "navigateToTotalRGPList('CLOSED')" },
                { title: "Overdue RGPs", value: overdue, color: "text-red-600", boxClass: "metric-box-overdue", action: "navigateToTotalRGPList('OPEN', true)" } 
            ];

            metrics.forEach(m => {
                const box = `
                    <div onclick="${m.action}" 
                         class="p-4 rounded-lg text-center shadow-inner ${m.boxClass} cursor-pointer transition duration-150 transform hover:shadow-lg hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 font-medium">${m.title}</p>
                        <p class="text-3xl font-extrabold mt-1 ${m.color}">${m.value}</p>
                    </div>
                `;
                metricsContainer.innerHTML += box;
            });

            // --- Vendor Bar Chart Rendering (Dashboard) ---
            const vendorContainer = document.getElementById('vendor-panel');
            vendorContainer.innerHTML = '';
            
            if (vendorCounts.length > 0) {
                const maxCount = vendorCounts.length > 0 ? vendorCounts[0][1] : 1; 
                
                vendorCounts.slice(0, 5).forEach(([vendor, count]) => {
                    const widthPercent = (count / maxCount) * 100;

                    const barChartItem = `
                        <div class="vendor-bar-container">
                            <div class="vendor-label truncate">${vendor}</div>
                            <div class="flex-grow bg-gray-200 rounded-md">
                                <div class="vendor-bar" style="width: ${widthPercent}%; background-color: #4f46e5;"></div>
                            </div>
                            <div class="vendor-count">${count}</div>
                        </div>
                    `;
                    vendorContainer.innerHTML += barChartItem;
                });
            } else {
                vendorContainer.innerHTML = '<p class="text-gray-500 italic p-3">No open RGPs to analyze vendors.</p>';
            }
        }


        // --- NEW RGP FORM VIEW RENDERING & LOGIC (MODIFIED: handleSaveNewRGP uses Apps Script) ---
        
        async function handleSaveNewRGP(event) {
            event.preventDefault(); // Stop form submission

            const form = event.target;
            const materials = [];
            let validationFailed = false;

            // 1. Gather & Validate Basic Fields
            if (!form['rgp-number'].value.trim() || !form['rgp-vendor'].value.trim() || !form['rgp-sent-by'].value.trim() || 
                !form['rgp-date'].value || !form['rgp-return-date'].value) {
                showMessage("Validation Error", "Please fill all mandatory RGP Header fields.", true);
                return;
            }

            const rgpNumberToCheck = form['rgp-number'].value.trim();

            // 2. Gather & Validate Material Fields
            const materialContainers = form.querySelectorAll('#material-entry-panel > div > div.grid-cols-4');
            if (materialContainers.length === 0) {
                showMessage("Validation Error", "Please add at least one material entry.", true);
                return;
            }

            materialContainers.forEach((container, index) => {
                const desc = container.querySelector(`[name="material-desc-${index}"]`).value.trim();
                const initialQtyStr = container.querySelector(`[name="initial-qty-${index}"]`).value;
                const initialQty = parseFloat(initialQtyStr);
                const unit = container.querySelector(`[name="unit-${index}"]`).value.trim();
                const remarks = container.querySelector(`[name="remarks-${index}"]`).value.trim();

                if (!desc || isNaN(initialQty) || initialQty <= 0 || !unit) {
                    validationFailed = true;
                    showMessage("Validation Error", `Material #${index + 1} has missing or invalid details.`, true);
                }

                materials.push({
                    id: index + 1, 
                    desc: desc,
                    initial_qty: initialQty,
                    returned_qty: 0, 
                    unit: unit,
                    remarks: remarks,
                });
            });

            if (validationFailed) return;

            // 3. Create new RGP object
            const newRGP = {
                action: 'saveNewRGP', 
                db_name: PRIMARY_DB_NAME, // Explicitly tell the script which DB to target
                status: "OPEN",
                sent_to: form['rgp-vendor'].value.trim(),
                sent_by: form['rgp-sent-by'].value.trim(),
                rgp_number: rgpNumberToCheck,
                issue_date: form['rgp-date'].value,
                expected_return_date: form['rgp-return-date'].value,
                materials: materials
            };

            // 4. Save to Apps Script
            try {
                // The script is expected to handle duplicate check and saving
                await callAppsScript('saveRGP', newRGP, 'POST'); 
                
                // Success actions: Show message & clear fields
                showMessage("Success", `RGP ${newRGP.rgp_number} created successfully and saved.`, false);
                
                // Clear fields after successful entry
                form.reset();
                renderNewRGPFormMaterials(); // Re-render material list to default (1 item)
                
                // Refresh the underlying data to update dashboard metrics and lists
                fetchRGPData(); 

            } catch (e) {
                showMessage("Database Error", `Failed to save RGP ${newRGP.rgp_number}. Reason: ${e.message}`, true);
            }
        }
        
        function renderNewRGPView() {
            const contentDiv = document.getElementById('main-content');
            const currentDate = formatDate(new Date());
            const returnDate = dateOffset(30);

            contentDiv.innerHTML = `
                <div class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800 justify-self-start">New RGP Entry</h2>
                    <div class="justify-self-center">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain">
                    </div>
                    <div class="flex items-center space-x-2 justify-self-end">
                        <button onclick="goBack()" class="bg-gray-500 text-white px-4 py-2 rounded-xl shadow-md hover:bg-gray-600 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                            Back
                        </button>
                        <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                            Home
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <form id="new-rgp-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <label class="block">
                                <span class="text-gray-700 font-medium">RGP Number <span class="text-red-500">*</span></span>
                                <input type="text" id="rgp-number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">Vendor / Sent To: <span class="text-red-500">*</span></span>
                                <input type="text" id="rgp-vendor" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">Sent By: <span class="text-red-500">*</span></span>
                                <input type="text" id="rgp-sent-by" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                            </label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <label class="block">
                                <span class="text-gray-700 font-medium">RGP Issue Date <span class="text-red-500">*</span></span>
                                <input type="date" id="rgp-date" required value="${currentDate}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">Expected Return Date <span class="text-red-500">*</span></span>
                                <input type="date" id="rgp-return-date" required value="${returnDate}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">Number of Materials: <span class="text-red-500">*</span></span>
                                <input type="number" id="rgp-num-materials" min="1" max="10" value="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                            </label>
                        </div>

                        <div id="material-entry-panel" class="space-y-4 pt-4 border-t border-gray-200">
                            </div>

                        <div class="flex justify-end">
                            <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-xl shadow-md hover:bg-green-700 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                Create New RGP
                            </button>
                        </div>
                    </form>
                </div>
            `;
            // Attach listeners and initial render
            document.getElementById('new-rgp-form').addEventListener('submit', handleSaveNewRGP);
            document.getElementById('rgp-num-materials').addEventListener('change', renderNewRGPFormMaterials);
            renderNewRGPFormMaterials(); // Initial render of materials
        }

        function renderNewRGPFormMaterials() {
            const numMaterialsInput = document.getElementById('rgp-num-materials');
            const numMaterials = parseInt(numMaterialsInput.value) || 1;
            const container = document.getElementById('material-entry-panel');
            container.innerHTML = `<h3 class="text-lg font-semibold text-gray-700 mb-3">Material Details (Total: ${numMaterials})</h3>`;
            let html = '<div class="space-y-4">';

            for (let i = 0; i < numMaterials; i++) {
                html += `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <span class="text-sm font-bold text-gray-600 md:col-span-4">Material #${i + 1}</span>
                        <label class="block md:col-span-2">
                            <span class="text-gray-700 text-sm">Description <span class="text-red-500">*</span></span>
                            <input type="text" name="material-desc-${i}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Initial Quantity <span class="text-red-500">*</span></span>
                            <input type="number" name="initial-qty-${i}" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Unit <span class="text-red-500">*</span></span>
                            <input type="text" name="unit-${i}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                        </label>
                        <label class="block md:col-span-3">
                            <span class="text-gray-700 text-sm">Remarks</span>
                            <input type="text" name="remarks-${i}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                        </label>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML += html;
        }

        // --- RETURN ENTRY VIEW RENDERING & LOGIC (MODIFIED: handleSaveReturnEntry uses Apps Script) ---

        /**
         * Handles the saving of the return entry data by calling the Apps Script.
         */
        async function handleSaveReturnEntry(event) {
            event.preventDefault();

            if (!selectedRGP) {
                showMessage("Error", "No RGP selected for return entry.", true);
                return;
            }

            const form = document.getElementById('return-entry-form');
            const returnEntries = [];
            let validationFailed = false;
            let totalReturnQty = 0;

            // 1. Validate Return Quantities
            selectedRGP.materials.forEach(material => {
                const input = form.querySelector(`input[data-material-id="${material.id}"]`);
                if (!input) return; 
                
                const returnQty = parseInt(input.value) || 0;
                const outstanding = material.initial_qty - material.returned_qty;

                if (returnQty < 0 || returnQty > outstanding) {
                    validationFailed = true;
                    showMessage("Validation Error", `Return quantity for ${material.desc} is invalid (must be between 0 and ${outstanding}).`, true);
                }
                
                if (returnQty > 0) {
                    returnEntries.push({ 
                        materialId: material.id, 
                        returnQty: returnQty 
                    });
                    totalReturnQty += returnQty;
                }
            });

            if (validationFailed) return;

            if (totalReturnQty === 0) {
                showMessage("Validation Error", "Please enter a return quantity greater than zero for at least one material.", true);
                return;
            }
            
            // 2. Prepare Update Data for Apps Script
            const updatePayload = {
                action: 'saveReturnEntry',
                db_name: PRIMARY_DB_NAME, // Explicitly tell the script which DB to target
                rgpId: selectedRGP.id, // Use the unique ID from the fetched data
                rgpNumber: selectedRGP.rgp_number, 
                returnDetails: returnEntries,
                // The script will calculate the new 'status' and 'materials' array
            };

            // 3. Save to Apps Script
            try {
                await callAppsScript('saveRGP', updatePayload, 'POST'); 

                // Success actions: Show message & clear fields
                // Note: The fullyReturned check below is based on the assumption BEFORE the save. 
                // The script will confirm the final status.
                showMessage("Success", `Return entry saved for RGP ${selectedRGP.rgp_number}. Data will now refresh.`, false);
                
                // Clear the form and reset state for the next entry
                document.getElementById('return-entry-form').reset();
                selectedRGP = null;
                selectedRGPNumber = null;
                renderReturnEntryDynamicDetails(); // Re-render the form to its initial state

                // Refresh the underlying data to update dashboard metrics and lists
                fetchRGPData(); 

            } catch (e) {
                showMessage("Database Error", `Failed to save return entry for RGP ${selectedRGP.rgp_number}. Reason: ${e.message}`, true);
            }
        }

        /** * Renders the material list table for the return entry view. (UNCHANGED) 
         * @param {object|null} rgp - The selected RGP object. 
         */ 
        function renderReturnMaterialList(rgp) { 
            const container = document.getElementById('rgp-material-list-container'); 
            if (!container) return; 

            if (!rgp || rgp.status.toUpperCase() === 'CLOSED') {
                container.innerHTML = rgp && rgp.status.toUpperCase() === 'CLOSED' ? 
                    '<p class="text-lg text-green-600 font-semibold p-4 bg-green-50 rounded-lg">This RGP is already CLOSED.</p>' :
                    '<p class="text-gray-500 italic p-4">Please enter a valid RGP Number to see material details.</p>';
                return;
            }

            const materialsHtml = ` 
                <div class="overflow-x-auto custom-scrollbar"> 
                    <table class="min-w-full divide-y divide-gray-200"> 
                        <thead class="bg-gray-50"> 
                            <tr> 
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th> 
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Initial Qty</th> 
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Returned Qty</th> 
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Outstanding</th> 
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Return Now</th> 
                            </tr> 
                        </thead> 
                        <tbody class="bg-white divide-y divide-gray-200"> 
                            ${rgp.materials.map(material => { 
                                const outstanding = material.initial_qty - material.returned_qty; 
                                if (outstanding <= 0) return ''; // Skip fully returned materials
                                return ` 
                                    <tr class="hover:bg-gray-50"> 
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${material.desc}</td> 
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${material.initial_qty}</td> 
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${material.returned_qty}</td> 
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center font-semibold text-${outstanding > 0 ? 'red-600' : 'green-600'}">${outstanding}</td> 
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center"> 
                                            <input type="number" name="return_qty_${material.id}" data-material-id="${material.id}" max="${outstanding}" min="0" value="0" class="w-20 text-center rounded-md border-gray-300 shadow-sm p-1 text-sm focus:border-indigo-500 focus:ring-indigo-500" > 
                                        </td> 
                                    </tr> 
                                `; 
                            }).join('')} 
                        </tbody> 
                    </table> 
                </div> 
            `; 
            container.innerHTML = materialsHtml; 
        } 

        /** * Dynamic function to handle RGP number input, perform lookup, and update UI. (UNCHANGED)
         */ 
        function renderReturnEntryDynamicDetails() { 
            const rgpNumberInput = document.getElementById('rgp-number-lookup'); 
            const rgpNumber = rgpNumberInput.value.trim().toUpperCase(); 
            
            // 1. Perform Lookup & Update State 
            let rgp = null; 
            if (rgpNumber.length > 0) { 
                rgp = RGPManager.find_rgp_by_number(rgpNumber); 
            } 
            selectedRGP = rgp; 
            selectedRGPNumber = rgpNumber; 

            // 2. Build Details Panel HTML 
            let rgpDetailsHtml = ''; 
            let saveButtonText = 'Save Return Entry'; 
            let saveButtonDisabled = true; 
            const materialsToDisplay = rgp ? rgp.materials : []; 

            if (rgp) { 
                saveButtonDisabled = rgp.status.toUpperCase() === 'CLOSED';
                rgpDetailsHtml = ` 
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"> 
                        <p class="font-medium text-gray-700">RGP No:</p><p class="font-bold text-gray-900">${rgp.rgp_number}</p>
                        <p class="font-medium text-gray-700">Issue Date:</p><p class="font-bold text-gray-900">${formatDateDisplay(rgp.issue_date)}</p>
                        <p class="font-medium text-gray-700">Vendor:</p><p class="font-bold text-gray-900 truncate" title="${rgp.sent_to}">${rgp.sent_to}</p>
                        <p class="font-medium text-gray-700">Expected Return:</p><p class="font-bold text-gray-900">${formatDateDisplay(rgp.expected_return_date)}</p>
                        <p class="font-medium text-gray-700">Sent By:</p><p class="font-bold text-gray-900">${rgp.sent_by}</p>
                        <p class="font-medium text-gray-700">Status:</p><p class="font-bold text-${rgp.status.toUpperCase() === 'CLOSED' ? 'green-600' : 'red-600'}">${rgp.status.toUpperCase()}</p>
                    </div>`; 
            } else if (rgpNumber.length > 0) {
                // RGP not found
                rgpDetailsHtml = `<div class="bg-yellow-50 p-4 rounded-lg text-sm text-yellow-800 font-medium">RGP Number ${rgpNumber} not found in the database.</div>`;
            } else {
                rgpDetailsHtml = `<div class="bg-gray-200 p-4 rounded-lg text-sm text-gray-700 font-medium">Enter an RGP Number to see details.</div>`;
            }
            
            // 3. Update UI
            document.getElementById('rgp-details-panel').innerHTML = rgpDetailsHtml; 
            renderReturnMaterialList(rgp); 

            const saveButton = document.getElementById('save-return-btn');
            if (saveButton) {
                saveButton.textContent = saveButtonText;
                saveButton.disabled = saveButtonDisabled;
                saveButton.className = saveButtonDisabled 
                    ? 'bg-gray-400 text-white px-6 py-3 rounded-xl shadow-md cursor-not-allowed'
                    : 'bg-green-600 text-white px-6 py-3 rounded-xl shadow-md hover:bg-green-700 transition duration-150';
            }
        }
        
        function renderReturnEntryView() {
            const contentDiv = document.getElementById('main-content');
            
            contentDiv.innerHTML = ` 
                <div class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6"> 
                    <h2 class="text-2xl font-semibold text-gray-800 justify-self-start">RGP Return Entry</h2> 
                    <div class="justify-self-center"> 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain"> 
                    </div> 
                    <div class="flex items-center space-x-2 justify-self-end"> 
                        <button onclick="goBack()" class="bg-gray-500 text-white px-4 py-2 rounded-xl shadow-md hover:bg-gray-600 transition duration-150"> 
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg> 
                            Back 
                        </button> 
                        <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150"> 
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> 
                            Home 
                        </button> 
                    </div> 
                </div> 

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="mb-6 flex space-x-4 items-end">
                        <label class="block flex-grow">
                            <span class="text-gray-700 font-medium">Enter RGP Number to Lookup:</span>
                            <input type="text" id="rgp-number-lookup" 
                                   value="${selectedRGPNumber || ''}"
                                   oninput="renderReturnEntryDynamicDetails()" 
                                   placeholder="RGP-0001" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 uppercase">
                        </label>
                        <button onclick="renderReturnEntryDynamicDetails()" class="bg-indigo-500 text-white px-6 py-2 h-11 rounded-xl shadow-md hover:bg-indigo-600 transition duration-150 flex-shrink-0">
                            Lookup
                        </button>
                    </div>

                    <div id="rgp-details-panel" class="mb-6 p-4 border border-dashed border-gray-300 rounded-xl">
                        <div class="bg-gray-200 p-4 rounded-lg text-sm text-gray-700 font-medium">Enter an RGP Number to see details.</div>
                    </div>

                    <form id="return-entry-form" onsubmit="handleSaveReturnEntry(event)">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 pt-4 border-t border-gray-100">Material Return Details</h3>
                        
                        <div id="rgp-material-list-container" class="mb-6">
                             <p class="text-gray-500 italic p-4">Material list will appear here after lookup.</p>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" id="save-return-btn" disabled class="bg-gray-400 text-white px-6 py-3 rounded-xl shadow-md cursor-not-allowed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                Save Return Entry
                            </button>
                        </div>
                    </form>
                </div>
            `;
            // Initial render of dynamic content (details and material list)
            renderReturnEntryDynamicDetails(); 
        }

        // --- PENDING RGP LIST VIEW RENDERING & FILTERING (UNCHANGED) --- 
        function updateRGPListUI(data, tbodyId, titleId) {
            const rows = dataToRowData(data);
            renderRGPTableBody(rows, tbodyId);

            // Update header with count
            const titleElement = document.getElementById(titleId);
            if (titleElement) {
                const totalCount = [...new Set(data.map(r => r.rgp_number))].length;
                titleElement.textContent = `Pending RGP List (${totalCount} Unique RGPs)`;
            }
        }
        
        function renderPendingRGPListView() { 
            const contentDiv = document.getElementById('main-content'); 
            // Filter is simplified since we only show OPEN items in this view. 
            const dataToDisplay = pendingRGPData.filter(rgp => rgp.materials.some(m => m.initial_qty > m.returned_qty)); 
            filteredRGPData = dataToDisplay; 
            contentDiv.innerHTML = ` 
                <div class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6"> 
                    <h2 id="pending-list-title" class="text-2xl font-semibold text-gray-800 justify-self-start">Pending RGP List</h2> 
                    <div class="justify-self-center"> 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain"> 
                    </div> 
                    <div class="flex items-center space-x-2 justify-self-end"> 
                        <button onclick="goBack()" class="bg-gray-500 text-white px-4 py-2 rounded-xl shadow-md hover:bg-gray-600 transition duration-150"> 
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg> 
                            Back 
                        </button> 
                        <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150"> 
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> 
                            Home 
                        </button> 
                    </div> 
                </div> 

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <button onclick="exportPendingRGPList()" class="bg-blue-600 text-white px-4 py-2 mb-4 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        Export to Excel
                    </button>
                    <div class="overflow-x-auto custom-scrollbar shadow-md sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RGP No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor / Sent To</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sent By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material Desc</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Exp. Return Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Days Open</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Initial Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Returned Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Outstanding Qty</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="rgp-list-tbody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div> 
            `; 
            updateRGPListUI(dataToDisplay, 'rgp-list-tbody', 'pending-list-title'); 
        } 

        // --- TOTAL RGP LIST VIEW RENDERING & FILTERING (UNCHANGED) --- 
        function renderTotalRGPListView() { 
            const contentDiv = document.getElementById('main-content'); 
            let analyticsStatusMessage = ''; 
            if (window.analyticsFilterType === 'vendor' && window.analyticsFilterValue) { 
                analyticsStatusMessage = `<p class="text-indigo-600 font-bold mb-4 bg-indigo-100 p-3 rounded-lg border border-indigo-200">NOTE: Showing only Open RGPs for Vendor: <strong>${window.analyticsFilterValue}</strong>. <button onclick="navigateToTotalRGPList('ALL')" class="text-sm text-indigo-800 ml-4 underline">Clear Vendor Filter</button></p>`; 
            } else if (window.analyticsFilterType === 'user' && window.analyticsFilterValue) { 
                analyticsStatusMessage = `<p class="text-purple-600 font-bold mb-4 bg-purple-100 p-3 rounded-lg border border-purple-200">NOTE: Showing only Open RGPs sent by User: <strong>${window.analyticsFilterValue}</strong>. <button onclick="navigateToTotalRGPList('ALL')" class="text-sm text-purple-800 ml-4 underline">Clear User Filter</button></p>`; 
            } 
            const overdueStatusMessage = window.totalRGPOverdueFilter ? `<p class="text-red-600 font-bold mb-4 bg-red-100 p-3 rounded-lg border border-red-200">NOTE: Showing only Overdue RGPs.</p>` : '';
            const clearFilterAction = window.analyticsFilterType || window.totalRGPOverdueFilter ? "navigateToTotalRGPList('ALL')" : "document.getElementById('total-rgp-filter-text').value = ''; filterTotalRGPData();";

            // Re-filter before rendering
            filterTotalRGPData();
            
            contentDiv.innerHTML = ` 
                <div class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6"> 
                    <h2 id="total-list-title" class="text-2xl font-semibold text-gray-800 justify-self-start">Total RGP List</h2> 
                    <div class="justify-self-center"> 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain"> 
                    </div> 
                    <div class="flex items-center space-x-2 justify-self-end"> 
                        <button onclick="goBack()" class="bg-gray-500 text-white px-4 py-2 rounded-xl shadow-md hover:bg-gray-600 transition duration-150"> 
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg> 
                            Back 
                        </button> 
                        <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150"> 
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> 
                            Home 
                        </button> 
                        <button onclick="exportTotalRGPList()" class="bg-green-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-green-700 transition duration-150"> 
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> 
                            Export 
                        </button> 
                    </div> 
                </div> 
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6"> 
                    ${analyticsStatusMessage} 
                    ${overdueStatusMessage} 
                    <div class="flex space-x-4"> 
                        <input type="text" id="total-rgp-filter-text" placeholder="Filter by RGP No., Vendor, User or Material..." value="${window.totalRGPFilterText}" class="block w-1/3 rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2" oninput="filterTotalRGPData()"> 
                        <select id="total-rgp-status-filter" class="block w-1/6 rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2" onchange="window.totalRGPOverdueFilter = false; filterTotalRGPData()"> 
                            <option value="ALL">All Statuses</option> 
                            <option value="OPEN" ${window.totalRGPStatusFilter === 'OPEN' ? 'selected' : ''}>Open</option> 
                            <option value="CLOSED" ${window.totalRGPStatusFilter === 'CLOSED' ? 'selected' : ''}>Closed</option> 
                        </select> 
                        <button onclick="${clearFilterAction}" class="bg-gray-500 text-white px-4 py-2 rounded-xl shadow-md hover:bg-gray-600 transition duration-150"> 
                            Clear Filters 
                        </button> 
                    </div> 
                </div> 
                <div class="bg-white p-6 rounded-xl shadow-lg"> 
                    <div class="overflow-x-auto custom-scrollbar shadow-md sm:rounded-lg"> 
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RGP No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor / Sent To</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sent By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material Desc</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Exp. Return Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Days Open</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Initial Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Returned Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Outstanding Qty</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="total-rgp-list-tbody" class="bg-white divide-y divide-gray-200"> 
                            </tbody> 
                        </table> 
                    </div> 
                </div> 
            `; 
            updateRGPListUI(window.filteredTotalRGPData, 'total-rgp-list-tbody', 'total-list-title');
        }

        // --- APPROVAL RGP LIST VIEW RENDERING & FILTERING (UNCHANGED) --- 

        function renderApprovalRGPListView() {
            const contentDiv = document.getElementById('main-content');
            // Data is already filtered in window.approvalRGPData. We only need to display them.
            const dataToDisplay = window.approvalRGPData;
            window.filteredApprovalRGPData = dataToDisplay; 

            contentDiv.innerHTML = `
                <div class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 id="approval-list-title" class="text-2xl font-semibold text-gray-800 justify-self-start">RGP List for Approval</h2>
                    <div class="justify-self-center">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain">
                    </div>
                    <div class="flex items-center space-x-2 justify-self-end">
                        <button onclick="goBack()" class="bg-gray-500 text-white px-4 py-2 rounded-xl shadow-md hover:bg-gray-600 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                            Back
                        </button>
                        <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                            Home
                        </button>
                        <button onclick="exportApprovalRGPList()" class="bg-green-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-green-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Export
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <p class="text-red-600 font-bold mb-4 bg-red-100 p-3 rounded-lg border border-red-200">
                        This list shows OPEN RGPs that are past their expected return date OR are 30+ days old (calculated from Issue Date).
                    </p>
                    <div class="overflow-x-auto custom-scrollbar shadow-md sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RGP No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor / Sent To</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sent By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material Desc</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Exp. Return Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Days Open</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Outstanding Qty</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="approval-list-tbody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            updateRGPListUI(dataToDisplay, 'approval-list-tbody', 'approval-list-title'); 
        }

        // --- ANALYTICS VIEW RENDERING & LOGIC (UNCHANGED, but depends on new fetchRGPData) ---

        function renderUserBarChart(userCounts) { 
            let html = ''; 
            if (userCounts.length === 0) { 
                return '<p class="text-gray-500 italic p-3">No open RGPs to analyze users.</p>'; 
            } 
            const maxCount = userCounts[0][1] > 0 ? userCounts[0][1] : 1; 
            userCounts.slice(0, 5).forEach(([user, count]) => { 
                const widthPercent = (count / maxCount) * 100; 
                html += ` 
                    <div onclick="navigateToAnalyticsFilter('user', '${user}')" class="vendor-bar-container cursor-pointer hover:bg-purple-50 p-1 rounded transition duration-150"> 
                        <div class="vendor-label truncate">${user}</div> 
                        <div class="flex-grow bg-gray-200 rounded-md"> 
                            <div class="vendor-bar" style="width: ${widthPercent}%; background-color: #8b5cf6;"></div> 
                        </div> 
                        <div class="vendor-count">${count}</div> 
                    </div> `; 
            }); 
            return html; 
        } 
        
        function renderVendorBarChart(vendorCounts) { 
            let html = ''; 
            if (vendorCounts.length === 0) { 
                return '<p class="text-gray-500 italic p-3">No open RGPs to analyze vendors.</p>'; 
            } 
            const maxCount = vendorCounts[0][1] > 0 ? vendorCounts[0][1] : 1; 
            vendorCounts.slice(0, 5).forEach(([vendor, count]) => { 
                const widthPercent = (count / maxCount) * 100; 
                html += ` 
                    <div onclick="navigateToAnalyticsFilter('vendor', '${vendor}')" class="vendor-bar-container cursor-pointer hover:bg-indigo-50 p-1 rounded transition duration-150"> 
                        <div class="vendor-label truncate">${vendor}</div> 
                        <div class="flex-grow bg-gray-200 rounded-md"> 
                            <div class="vendor-bar" style="width: ${widthPercent}%; background-color: #4f46e5;"></div> 
                        </div> 
                        <div class="vendor-count">${count}</div> 
                    </div> `; 
            }); 
            return html; 
        } 
        
        function renderAnalyticsView(data) { 
            const contentDiv = document.getElementById('main-content'); 
            const totalRgpCount = RGPManager.get_total_rgps(data); 
            const openRgpCount = RGPManager.get_open_rgps(data); 
            const closedRgpCount = RGPManager.get_closed_rgps(data);
            const overdueRgpCount = RGPManager.get_overdue_rgps(data); 
            const totalOutstandingQty = RGPManager.get_total_outstanding_qty(data); 
            const avgDaysOpen = RGPManager.get_avg_days_open(data); 
            const openToTotalRatio = totalRgpCount > 0 ? ((openRgpCount / totalRgpCount) * 100).toFixed(1) : 0; 
            const vendorCounts = RGPManager.get_vendor_open_counts(data); 
            const userCounts = RGPManager.get_user_open_counts(data); 
            
            contentDiv.innerHTML = ` 
                <div class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800 justify-self-start">Analytics & Reports</h2>
                    <div class="justify-self-center">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain">
                    </div>
                    <div class="flex items-center space-x-2 justify-self-end">
                        <button onclick="goBack()" class="bg-gray-500 text-white px-4 py-2 rounded-xl shadow-md hover:bg-gray-600 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                            Back
                        </button>
                        <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                            Home
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                    <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Key Performance Indicators</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div onclick="navigateToTotalRGPList('ALL')" class="p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-150 border-l-4 border-blue-500 bg-blue-50">
                            <p class="text-sm text-gray-500 font-medium">Total RGPs</p>
                            <p class="text-3xl font-extrabold mt-1 text-blue-600">${totalRgpCount}</p>
                        </div>
                        <div onclick="navigateToTotalRGPList('OPEN')" class="p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-150 border-l-4 border-orange-500 bg-orange-50">
                            <p class="text-sm text-gray-500 font-medium">Open RGPs</p>
                            <p class="text-3xl font-extrabold mt-1 text-orange-600">${openRgpCount}</p>
                        </div>
                        <div onclick="navigateToTotalRGPList('OPEN', true)" class="p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-150 border-l-4 border-red-500 bg-red-50">
                            <p class="text-sm text-gray-500 font-medium">Overdue RGPs</p>
                            <p class="text-3xl font-extrabold mt-1 ${overdueRgpCount > 0 ? 'text-red-600' : 'text-gray-600'}">${overdueRgpCount}</p>
                        </div>
                        <div class="p-4 rounded-xl shadow-md border-l-4 border-green-500 bg-green-50">
                            <p class="text-sm text-gray-500 font-medium">Avg. Days Open (Open RGPs)</p>
                            <p class="text-3xl font-extrabold mt-1 text-green-600">${avgDaysOpen}</p>
                        </div>
                        <div class="p-4 rounded-xl shadow-md border-l-4 border-purple-500 bg-purple-50">
                            <p class="text-sm text-gray-500 font-medium">Total Outstanding Qty</p>
                            <p class="text-3xl font-extrabold mt-1 text-purple-600">${totalOutstandingQty}</p>
                        </div>
                        <div class="p-4 rounded-xl shadow-md border-l-4 border-cyan-500 bg-cyan-50">
                            <p class="text-sm text-gray-500 font-medium">Open / Total Ratio</p>
                            <p class="text-3xl font-extrabold mt-1 text-cyan-600">${openToTotalRatio}%</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 pt-4">RGP Distribution</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-150" title="Click to filter list by status">
                            <h4 class="text-lg font-semibold text-gray-700 mb-4">RGPs by Status (Total: ${totalRgpCount})</h4>
                            <div id="statusChartContainer" class="w-full max-w-sm mx-auto">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                        <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl shadow-md">
                            <h4 class="text-lg font-semibold text-gray-700 mb-4">Top 5 Vendors (Open RGPs)</h4>
                            <div id="vendor-chart-container" class="space-y-3">
                                ${renderVendorBarChart(vendorCounts)}
                            </div>
                        </div>
                        <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl shadow-md">
                            <h4 class="text-lg font-semibold text-gray-700 mb-4">Top 5 Users (Open RGPs)</h4>
                            <div id="user-chart-container" class="space-y-3">
                                ${renderUserBarChart(userCounts)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render Charts (Function remains unchanged)
            renderStatusChart(openRgpCount, closedRgpCount);

            // Helper function to render a simple Doughnut/Pie chart for RGP Status
            function renderStatusChart(openCount, closedCount) {
                const ctx = document.getElementById('statusChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Open', 'Closed'],
                        datasets: [{
                            data: [openCount, closedCount],
                            backgroundColor: ['#f97316', '#10b981'], // Orange for Open, Green for Closed
                            hoverBackgroundColor: ['#ea580c', '#059669'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            title: {
                                display: false,
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        onClick: (e, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const status = index === 0 ? 'OPEN' : 'CLOSED';
                                window.navigateToTotalRGPList(status);
                            }
                        }
                    }
                });
                // Fix for chart sizing in flex container
                document.getElementById('statusChartContainer').style.height = '300px'; 
                document.getElementById('statusChartContainer').style.width = '100%'; 
            }
        }


        // --- RGP LIST UTILITY FUNCTIONS (UNCHANGED) ---

        /** * Converts the RGP data array into a flattened row data array for table rendering. 
         * Includes logic for overdue calculation and material breakdown (rowspan). 
         */ 
        function dataToRowData(data) { 
            const today = new Date(); 
            today.setHours(0, 0, 0, 0); 
            const rowData = []; 

            data.forEach(rgp => { 
                const materialsList = rgp.materials || []; 
                if (materialsList.length === 0) return; 

                const rowSpan = materialsList.length; 
                const rgpStatus = rgp.status.toUpperCase(); 

                let isOverdue = false; 
                if (rgpStatus === "OPEN" && rgp.expected_return_date) { 
                    try { 
                        const expectedReturnDate = parseDate(rgp.expected_return_date); 
                        const thirtyDaysAfterReturn = new Date(expectedReturnDate);
                        thirtyDaysAfterReturn.setDate(expectedReturnDate.getDate() + 30);
                        isOverdue = today > thirtyDaysAfterReturn;
                    } catch (e) { 
                        console.error("Date parsing error during row data conversion:", rgp.id, e); 
                    } 
                } 

                let firstMaterial = true; 
                materialsList.forEach(material => { 
                    const materialOutstanding = material.initial_qty - material.returned_qty; 
                    const row = { 
                        rgpNumber: rgp.rgp_number, 
                        vendor: rgp.sent_to, 
                        sentBy: rgp.sent_by, 
                        issueDate: formatDateDisplay(rgp.issue_date), 
                        expectedReturnDate: formatDateDisplay(rgp.expected_return_date), 
                        status: rgp.status, 
                        daysOpen: rgp.days_open, 
                        rowClass: isOverdue ? 'bg-red-50 hover:bg-red-100' : (rgpStatus === 'CLOSED' ? 'bg-green-50 hover:bg-green-100' : 'hover:bg-gray-50'), 
                        isOverdue: isOverdue, 
                        materialDesc: material.desc, 
                        initialQty: material.initial_qty, 
                        returnedQty: material.returned_qty, 
                        outstandingQty: materialOutstanding, 
                        outstandingClass: materialOutstanding > 0 ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold', 
                        rowSpan: firstMaterial ? rowSpan : 0, 
                        isFirstMaterial: firstMaterial, 
                        rgpId: rgp.id // Needed for action button in lists
                    }; 
                    rowData.push(row); 
                    firstMaterial = false; 
                }); 
            }); 
            return rowData; 
        } 

        /** * Takes the row data and renders the HTML table body. 
         */ 
        function renderRGPTableBody(rows, tableId) { 
            const tbody = document.getElementById(tableId); 
            if (!tbody) return; 

            let html = ''; 
            rows.forEach(row => { 
                const rowClass = row.rowClass; 
                const isFirstMaterial = row.isFirstMaterial; 
                const daysOpenClass = row.daysOpen === 'N/A' || row.daysOpen < 30 ? 'text-gray-500' : 'text-gray-900'; 
                
                let rgpNoCell = ''; 
                let vendorCell = ''; 
                let sentByCell = ''; 
                let issueDateCell = ''; 
                let expectedReturnDateCell = '';
                let statusCell = ''; 
                let daysOpenCell = ''; 
                let actionCell = ''; 

                if (isFirstMaterial) { 
                    const statusColor = row.status.toUpperCase() === 'CLOSED' ? 'text-green-600' : 'text-red-600';

                    rgpNoCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 border-r border-gray-200">${row.rgpNumber}</td>`; 
                    vendorCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" title="${row.vendor}">${row.vendor}</td>`; 
                    sentByCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.sentBy}</td>`; 
                    issueDateCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${row.issueDate}</td>`; 
                    expectedReturnDateCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${row.expectedReturnDate}</td>`;
                    statusCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-center ${statusColor}">${row.status.toUpperCase()}</td>`; 
                    daysOpenCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-center ${daysOpenCell}">${row.daysOpen}</td>`; 
                    actionCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button onclick="editRGP('${row.rgpNumber}')" title="Go to Return Entry" class="text-indigo-600 hover:text-indigo-900 disabled:text-gray-400 disabled:cursor-not-allowed" 
                                            ${row.status.toUpperCase() === 'CLOSED' ? 'disabled' : ''}>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                        </button>
                                    </td>`;
                } 
                
                // Material Row
                const materialRow = `
                    <tr class="${rowClass}"> 
                        ${rgpNoCell} 
                        ${vendorCell} 
                        ${sentByCell} 
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${row.materialDesc}</td> 
                        ${issueDateCell} 
                        ${expectedReturnDateCell}
                        ${statusCell}
                        ${daysOpenCell} 
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${row.initialQty}</td> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${row.returnedQty}</td> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center ${row.outstandingClass}">${row.outstandingQty}</td> 
                        ${actionCell}
                    </tr> 
                `; 
                html += materialRow; 
            }); 
            tbody.innerHTML = html; 
        } 

        /** * Filters the Total RGP List based on current global filter state. 
         * Renders the table after filtering. 
         */ 
        function filterTotalRGPData() { 
            const filterInput = document.getElementById('total-rgp-filter-text'); 
            const statusSelect = document.getElementById('total-rgp-status-filter'); 

            // 1. Update global state from input fields
            if(filterInput) window.totalRGPFilterText = filterInput.value; 
            if(statusSelect) window.totalRGPStatusFilter = statusSelect.value;
            
            const filterText = (window.totalRGPFilterText || '').toLowerCase(); 
            const statusFilter = window.totalRGPStatusFilter; 
            const overdueFilter = window.totalRGPOverdueFilter; 

            const filteredData = currentRGPData.filter(rgp => { 
                const rgpStatus = rgp.status.toUpperCase(); 

                // a. Overdue Filter 
                if (overdueFilter) { 
                    if (rgpStatus !== 'OPEN') return false; 
                    // RGPManager.get_overdue_rgps expects an array, so pass the single RGP
                    const isOverdue = RGPManager.get_overdue_rgps([rgp]) > 0; 
                    if (!isOverdue) return false; 
                } 

                // b. Status Filter 
                const statusMatch = statusFilter === 'ALL' || rgpStatus === statusFilter; 
                if (!statusMatch) return false; 

                // c. Analytics Filters (Vendor or User) - Check against OPEN only 
                if (window.analyticsFilterType === 'vendor' && window.analyticsFilterValue) { 
                    if (rgpStatus !== 'OPEN' || rgp.sent_to.toLowerCase() !== window.analyticsFilterValue.toLowerCase()) return false; 
                } 
                if (window.analyticsFilterType === 'user' && window.analyticsFilterValue) { 
                    if (rgpStatus !== 'OPEN' || rgp.sent_by.toLowerCase() !== window.analyticsFilterValue.toLowerCase()) return false; 
                } 

                // d. Standard Text Filter 
                const textMatch = ( 
                    rgp.rgp_number.toLowerCase().includes(filterText) || 
                    rgp.sent_to.toLowerCase().includes(filterText) || 
                    rgp.sent_by.toLowerCase().includes(filterText) || 
                    (rgp.materials || []).some(m => m.desc.toLowerCase().includes(filterText)) 
                ); 
                
                // If an analytics filter is active, the standard filter is ignored to keep the targeted list pure.
                if (window.analyticsFilterType && window.analyticsFilterValue) {
                    return true;
                } else {
                    return textMatch;
                }
            }); 
            
            window.filteredTotalRGPData = filteredData; 
            updateRGPListUI(window.filteredTotalRGPData, 'total-rgp-list-tbody', 'total-list-title'); 
        } 
        
        // --- EXPORT LOGIC (UNCHANGED) ---

        /**
         * Helper to convert flattened row data to Excel-friendly array.
         * @param {Array<Object>} rows - The row data array.
         * @returns {Array<Array<any>>}
         */
        function rowsToExportData(rows) {
            const header = [
                'RGP No.', 'Vendor / Sent To', 'Sent By', 'Material Desc', 
                'Issue Date', 'Exp. Return Date', 'Status', 'Days Open', 
                'Initial Qty', 'Returned Qty', 'Outstanding Qty', 'Remarks', 'Unique ID'
            ];
            const data = [header];

            rows.forEach(row => {
                const material = (row.materials || []).find(m => m.desc === row.materialDesc) || {};
                
                data.push([
                    row.rgpNumber,
                    row.vendor,
                    row.sentBy,
                    row.materialDesc,
                    row.issueDate,
                    row.expectedReturnDate,
                    row.status,
                    row.daysOpen,
                    row.initialQty,
                    row.returnedQty,
                    row.outstandingQty,
                    material.remarks || '',
                    row.rgpId
                ]);
            });
            return data;
        }

        function exportToExcel(data, sheetName = 'RGP_Report', fileName = 'RGP_Report.xlsx') {
            if (data.length === 0) {
                showMessage("Export Error", "No data available to export.", true);
                return;
            }
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, fileName);
            showMessage("Export Success", `Data successfully exported to ${fileName}.`);
        }

        function exportPendingRGPList() {
            const rowData = dataToRowData(filteredRGPData);
            const exportData = rowsToExportData(rowData);
            exportToExcel(exportData, 'Pending_RGPs', 'Pending_RGP_List.xlsx');
        }

        function exportTotalRGPList() {
            const rowData = dataToRowData(window.filteredTotalRGPData);
            const exportData = rowsToExportData(rowData);
            exportToExcel(exportData, 'Total_RGPs', 'Total_RGP_List.xlsx');
        }

        function exportApprovalRGPList() {
            const rowData = dataToRowData(window.filteredApprovalRGPData);
            const exportData = rowsToExportData(rowData);
            exportToExcel(exportData, 'Approval_List', 'RGP_Approval_List.xlsx');
        }

        // --- NAVIGATION HELPERS FOR DASHBOARD CLICKS (UNCHANGED) ---

        // Function to navigate from Dashboard metrics to Total RGP List with specific filters
        window.navigateToTotalRGPList = function(status, overdue = false) {
            window.totalRGPFilterText = '';
            window.analyticsFilterType = null;
            window.analyticsFilterValue = null;
            window.totalRGPStatusFilter = status;
            window.totalRGPOverdueFilter = overdue;
            // The list view will call filterTotalRGPData() on render
            switchPage('totalList');
        }

        // Function to navigate from Analytics charts/lists to Total RGP List with specific filters
        window.navigateToAnalyticsFilter = function(filterType, filterValue) {
            window.totalRGPFilterText = '';
            window.totalRGPStatusFilter = 'OPEN';
            window.totalRGPOverdueFilter = false;
            window.analyticsFilterType = filterType;
            window.analyticsFilterValue = filterValue;
            // The list view will call filterTotalRGPData() on render
            switchPage('totalList');
        }

        // Function to navigate from RGP List action button to Return Entry
        window.editRGP = function(rgpNumber) {
            // Set the RGP number in state and let the page render function handle the lookup
            selectedRGPNumber = rgpNumber;
            // The state will be used by renderReturnEntryDynamicDetails() to pre-populate the form
            switchPage('returnEntry');
        }
        
        // --- APPLICATION STARTUP ---

        function renderDashboard(data) {
             renderPage(); 
        }

        // Run the initialization: Starts the data fetch which then calls renderPage().
        fetchRGPData(true); 

    </script>
</body>
</html>