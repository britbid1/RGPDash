<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGP Manager Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> 
    <style>
        /* Custom Styles for Button Colors to mimic the PySide6 app */
        .btn-new-rgp { background-color: #4f46e5; } /* Indigo */
        .btn-new-rgp:hover { background-color: #4338ca; }

        .btn-return { background-color: #10b981; } /* Green */
        .btn-return:hover { background-color: #059669; }

        .btn-pending { background-color: #f59e0b; } /* Orange */
        .btn-pending:hover { background-color: #d97706; }

        .btn-total { background-color: #3b82f6; } /* Blue */
        .btn-total:hover { background-color: #2563eb; }

        .btn-analytics { background-color: #8b5cf6; } /* Purple */
        .btn-analytics:hover { background-color: #7c3aed; }
        
        /* NEW STYLE FOR APPROVAL BUTTON */
        .btn-approval { background-color: #06b6d4; } /* Cyan */
        .btn-approval:hover { background-color: #0891b2; }

        .metric-box-base {
            background-color: #f9fafb; 
            border: 1px solid #e5e7eb;
        }

        .metric-box-overdue {
            background-color: #fee2e2; 
            border: 1px solid #fca5a5;
        }

        /* Styles for Bar Charts (Vendors/Users) */
        .vendor-bar-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .vendor-label {
            flex-basis: 120px;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .vendor-bar {
            height: 20px;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        .vendor-count {
            font-weight: bold;
            flex-shrink: 0;
            min-width: 20px;
            text-align: right;
        }

        /* Custom scrollbar for table */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading-spinner" class="text-center mt-20">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Loading application...</p>
    </div>

    <div id="main-content" class="container mx-auto hidden">
        <div id="message-container" class="fixed bottom-4 left-4 z-50 w-80"></div>
    </div>

    <script type="module">
        // Removed all Firebase imports as the backend is now Google Apps Script
        
        // --- GOOGLE APPS SCRIPT CONFIGURATION ---
        const APPS_SCRIPT_URL = 'https://script.google.com/a/macros/britindia.com/s/AKfycbz1tirui5mTVMB-nfvIpiGHlcZ7trrrR66R8KQdSkiny66itm21ydQQ7xBde3-XedwDPg/exec';
        const PRIMARY_DB_NAME = 'RGP_Database'; 
        const BACKUP_DB_NAME = 'RGP_DB_Backup'; 

        // --- GLOBAL STATE ---
        let currentPage = 'dashboard';
        let pageHistory = [];
        let selectedRGP = null;
        let selectedRGPNumber = null;
        let pendingRGPData = []; // Store the full list of OPEN RGPs
        let filteredRGPData = []; // Store the list currently shown in the PENDING table (used for export)

        // --- GLOBAL STATE FOR TOTAL LIST VIEW (NEW) ---
        window.totalRGPFilterText = '';
        window.totalRGPStatusFilter = 'ALL';
        window.filteredTotalRGPData = [];
        window.totalRGPOverdueFilter = false; 
        // NEW: Analytics Filter State
        window.analyticsFilterType = null; 
        window.analyticsFilterValue = null; 
        
        // --- GLOBAL STATE FOR APPROVAL LIST VIEW (NEW) ---
        window.approvalRGPData = []; 
        window.filteredApprovalRGPData = []; 
        
        // --- PERSISTENT DATA STATE ---
        let currentRGPData = []; // Live data from Google Sheet

        /**
         * Converts the expected_return_date string to a Date object.
         * @param {string} dateStr - Date string in YYYY-MM-DD format.
         * @returns {Date}
         */
        function parseDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            // Months in JS are 0-indexed, so subtract 1
            return new Date(year, month - 1, day);
        }
        
        /**
         * Formats a Date object to YYYY-MM-DD string (for internal data & HTML inputs).
         * @param {Date} date - The date object.
         * @returns {string} YYYY-MM-DD
         */
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        /**
         * Formats a YYYY-MM-DD date string to DD/MM/YYYY string for display in lists.
         * @param {string} dateStr - Date string in YYYY-MM-DD format.
         * @returns {string} DD/MM/YYYY
         */
        function formatDateDisplay(dateStr) {
            if (!dateStr || dateStr.length !== 10) return dateStr;
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        /**
         * Adds days to a date and returns the YYYY-MM-DD string.
         * @param {number} days - Number of days to add.
         * @returns {string} YYYY-MM-DD
         */
        function dateOffset(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return formatDate(date);
        }

        // --- RGP MANAGER FUNCTIONS (UNCHANGED LOGIC) ---
        const RGPManager = {
            get_total_rgps: (data) => data.length,
            get_open_rgps: (data) => data.filter(r => r.status.toUpperCase() === "OPEN").length,
            get_closed_rgps: (data) => data.filter(r => r.status.toUpperCase() === "CLOSED").length,
            
            get_overdue_rgps: (data) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                return data.filter(r => {
                    if (r.status.toUpperCase() !== "OPEN" || !r.expected_return_date) return false;

                    try {
                        const expectedReturnDate = parseDate(r.expected_return_date);
                        // RGP is considered overdue if it's 30 days past the expected return date.
                        const thirtyDaysAfterReturn = new Date(expectedReturnDate);
                        thirtyDaysAfterReturn.setDate(expectedReturnDate.getDate() + 30);
                        
                        return today > thirtyDaysAfterReturn;

                    } catch (e) {
                        console.error("Date parsing error for RGP:", r.id, e);
                        return false;
                    }
                }).length;
            },

            get_vendor_open_counts: (data) => {
                const counts = {};
                data.forEach(r => {
                    if (r.status.toUpperCase() === "OPEN") {
                        const vendor = (r.sent_to || "Unknown").trim() || "Unknown";
                        counts[vendor] = (counts[vendor] || 0) + 1;
                    }
                });
                return Object.entries(counts).sort(([, a], [, b]) => b - a);
            },
            
            // New helper function to find RGP by number (Uses Sheet ID for lookups)
            find_rgp_by_number: (rgpNumber) => {
                return currentRGPData.find(r => rgpNumber && r.rgp_number.toUpperCase() === rgpNumber.toUpperCase());
            },

            // New helper function to get open RGPs
            get_pending_rgp_data: (data) => {
                return data.filter(r => r.status.toUpperCase() === "OPEN");
            },
            
            // New helper function to get RGPs for approval list 
            get_approval_rgp_data: (data) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                return data.filter(r => {
                    if (r.status.toUpperCase() !== "OPEN") return false;
                    
                    try {
                        const issueDate = parseDate(r.issue_date);
                        
                        // 1. Check if it has exceeded the Expected Return Date
                        let isOverdue = false;
                        const expectedReturnDate = parseDate(r.expected_return_date);
                        // Is overdue if today is strictly greater than expected return date
                        isOverdue = today > expectedReturnDate; 

                        // 2. Check if it is more than 30 days old from RGP Date (Issue Date)
                        const thirtyDaysAfterIssue = new Date(issueDate);
                        thirtyDaysAfterIssue.setDate(issueDate.getDate() + 30);
                        const isThirtyDaysOld = today > thirtyDaysAfterIssue;

                        // RGP must be OPEN AND (Exceeded Expected Return Date OR 30 Days Old from Issue Date)
                        return isOverdue || isThirtyDaysOld;
                    } catch (e) {
                        console.error("Date parsing error for RGP:", r.id, e);
                        return false;
                    }
                });
            }, 

            // Helper to calculate days open
            calculate_days_open: (issueDateStr) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                try {
                    const issueDate = parseDate(issueDateStr);
                    const diffTime = Math.abs(today - issueDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays;
                } catch (e) {
                    return 'N/A';
                }
            }, 

            // --- NEW ANALYTICS FUNCTIONS FOR ANALYTICS PAGE ---
            get_avg_days_open: (data) => {
                if (data.length === 0) return 0;
                
                const totalDays = data.reduce((sum, r) => {
                    const days = RGPManager.calculate_days_open(r.issue_date);
                    return sum + (typeof days === 'number' ? days : 0);
                }, 0);

                return (totalDays / data.length).toFixed(1);
            },
            
            get_total_outstanding_qty: (data) => {
                const totalOutstanding = data.reduce((sumRgp, rgp) => {
                    const rgpOutstanding = rgp.materials.reduce((sumMat, material) => {
                        return sumMat + (material.initial_qty - material.returned_qty);
                    }, 0);
                    return sumRgp + rgpOutstanding;
                }, 0);
                return totalOutstanding;
            },

            get_user_open_counts: (data) => {
                const counts = {};
                data.forEach(r => {
                    if (r.status.toUpperCase() === "OPEN") {
                        const user = (r.sent_by || "Unknown").trim() || "Unknown";
                        counts[user] = (counts[user] || 0) + 1;
                    }
                });
                return Object.entries(counts).sort(([, a], [, b]) => b - a);
            }
        };

        // --- MESSAGE & NOTIFICATION LOGIC (NEW/REFACTORED) ---

        /**
         * Displays an error or success message at the bottom-left of the screen.
         * @param {string} title - The title of the message.
         * @param {string} message - The message content.
         * @param {boolean} isError - True for red error message, false for green success message.
         */
        function showMessage(title, message, isError = false) {
            const container = document.getElementById('message-container');
            if (!container) {
                console.error(`Message UI container missing. Title: ${title}, Message: ${message}, Error: ${isError}`);
                return;
            }
            
            // Clear any previous message
            container.innerHTML = '';
            
            const messageDiv = document.createElement('div');
            const baseClasses = "p-4 rounded-xl shadow-lg transition-opacity duration-300";
            const errorClasses = "bg-red-600 text-white font-bold border-2 border-red-800";
            const successClasses = "bg-green-600 text-white font-bold border-2 border-green-800";

            messageDiv.className = `${baseClasses} ${isError ? errorClasses : successClasses}`;
            messageDiv.innerHTML = `
                <p class="font-bold">${title}</p>
                <p class="text-sm">${message}</p>
            `;

            container.appendChild(messageDiv);
            
            // Log to console for debugging as well
            if (isError) {
                console.error(`ERROR (${title}): ${message}`);
            } else {
                console.log(`${title}: ${message}`);
            }

            // Automatically hide the message after 5 seconds
            setTimeout(() => {
                messageDiv.classList.add('opacity-0');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300); // Wait for transition to finish
            }, 5000);
        }

        // --- APPS SCRIPT COMMUNICATION CORE (NEW) ---

        /**
         * Generic function to call the Google Apps Script Web App.
         * @param {string} action - The function/endpoint to call in the script (e.g., 'fetchAllRGP', 'saveNewRGP').
         * @param {object} [data={}] - The payload data to send (for POST requests).
         * @param {string} method - 'GET' or 'POST'.
         * @returns {Promise<object>} The JSON 'data' property of the response from the Apps Script.
         */
        async function callAppsScript(action, data = {}, method = 'GET') {
            const url = new URL(APPS_SCRIPT_URL);
            url.searchParams.append('action', action);
            
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            
            if (method === 'POST') {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url.toString(), options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // The Apps Script should return { status: 'success' | 'error', message: '...', data: [...] }
                if (result.status === 'error') {
                    throw new Error(result.message || 'Apps Script returned an unknown error.');
                }

                return result.data; // Return the actual data payload

            } catch (error) {
                console.error(`Apps Script Call Failed (${action}):`, error);
                throw new Error(`Server operation failed. Please check the network or server logs. Detail: ${error.message}`);
            }
        }


        // --- DATA FETCHING (REPLACING FIREBASE) ---

        /**
         * Fetches all RGP data from the Google Sheet via Apps Script.
         * This replaces the real-time Firestore listener with a fetch-and-refresh model.
         */
        async function fetchRGPData(isInitialLoad = false) {
            if (isInitialLoad) {
                document.getElementById('loading-spinner').classList.remove('hidden');
            }
            
            try {
                // Pass DB names (though the script usually handles the primary/backup logic)
                const payload = { primary: PRIMARY_DB_NAME, backup: BACKUP_DB_NAME };
                const fetchedData = await callAppsScript('fetchAllRGP', payload, 'GET'); 

                // Process data to calculate days_open
                const processedData = fetchedData.map(data => ({
                    ...data,
                    // Assuming the script returns the unique ID (key) as 'id'
                    days_open: RGPManager.calculate_days_open(data.issue_date) 
                }));

                // Update global state
                currentRGPData = processedData;
                
                // Re-calculate derived lists
                pendingRGPData = RGPManager.get_pending_rgp_data(currentRGPData);
                window.approvalRGPData = RGPManager.get_approval_rgp_data(currentRGPData);

                // Re-render the application with the new data
                renderPage(); // Call renderPage, which will re-render the current view
                
                console.log(`RGP data fetched successfully. Total RGPs: ${currentRGPData.length}`);

            } catch (error) {
                showMessage("Data Fetch Error", `Could not load RGP data from server: ${error.message}`, true);
                currentRGPData = []; // Clear data if fetch fails
                pendingRGPData = [];
                window.approvalRGPData = [];
                renderPage(); // Render empty dashboard
            } finally {
                if (isInitialLoad) {
                    document.getElementById('loading-spinner').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                }
            }
        }


        // --- NAVIGATION LOGIC (UNCHANGED) ---

        function goHome() {
            pageHistory = [];
            switchPage('dashboard');
        }

        function goBack() {
            if (pageHistory.length > 0) {
                const previousPage = pageHistory.pop();
                switchPage(previousPage, false); // Don't add back to history
            } else {
                goHome();
            }
        }
        
        // Expose navigation functions globally for inline HTML onclick handlers
        window.goHome = goHome;
        window.goBack = goBack;

        function switchPage(pageId, recordHistory = true) {
            if (currentPage !== pageId && recordHistory) {
                pageHistory.push(currentPage);
            }
            currentPage = pageId;
            renderPage();
            
            // Clear return entry state on page switch
            if (pageId !== 'returnEntry') {
                selectedRGP = null;
                selectedRGPNumber = null;
            }
        }

        // Renamed and kept original console logging
        // NOTE: All calls to the old 'showMessage' have been replaced with the new, visible showMessage.
        // The original logic here has been moved into the refactored showMessage above.

        function renderPage() {
            const contentDiv = document.getElementById('main-content');
            contentDiv.innerHTML = '';
            
            switch (currentPage) {
                case 'dashboard':
                    renderDashboardView(currentRGPData);
                    break;
                case 'newRGP':
                    renderNewRGPView();
                    break;
                case 'returnEntry':
                    renderReturnEntryView();
                    break;
                case 'pendingList':
                    renderPendingRGPListView();
                    break;
                case 'totalList':
                    renderTotalRGPListView();
                    break;
                case 'approvalList': 
                    renderApprovalRGPListView();
                    break; 
                case 'analytics': 
                    renderAnalyticsView(currentRGPData);
                    break;
                default:
                    renderDashboardView(currentRGPData);
            }
        }

        
        function handleButtonClick(action) {
            if (action === "New RGP Entry") {
                switchPage('newRGP');
            } else if (action === "Return Entry") {
                switchPage('returnEntry');
            } else if (action === "Pending RGP List") {
                // pendingRGPData is already updated by the data fetcher
                filteredRGPData = [...pendingRGPData];
                switchPage('pendingList'); 
            } else if (action === "Total RGP List") {
                 // Initialize state for Total List View (clear special filters)
                window.totalRGPFilterText = '';
                window.totalRGPStatusFilter = 'ALL';
                window.totalRGPOverdueFilter = false; 
                window.analyticsFilterType = null; // Clear analytics filter
                window.analyticsFilterValue = null; // Clear analytics filter
                // Initially, filtered data is all data
                window.filteredTotalRGPData = [...currentRGPData]; 
                switchPage('totalList');
            } else if (action === "Export Pending RGP List for Approval") { 
                 // approvalRGPData is already updated by the data fetcher
                 window.filteredApprovalRGPData = [...window.approvalRGPData];
                 switchPage('approvalList');
            } else if (action === "Analytics") { 
                switchPage('analytics');
            } else {
                showMessage("Navigation", `Navigating to ${action} functionality. (Placeholder)`);
            }
        }


        // --- DASHBOARD VIEW RENDERING (UNCHANGED) ---

        function renderDashboardView(data) {
            const contentDiv = document.getElementById('main-content');
            contentDiv.innerHTML = `
                <div id="dashboard-content">
                    <header class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                        <h1 class="text-2xl font-extrabold text-blue-600 justify-self-start">RGP Dashboard</h1>
                        <div class="justify-self-center">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain">
                        </div>
                        <div class="justify-self-end">
                            <span class="text-sm font-medium text-gray-500 hidden md:inline">V2.6.7</span>
                        </div>
                    </header>

                    <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">

                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg h-full">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Navigation & Quick Actions</h2>
                            <div id="navigation-panel" class="grid grid-cols-1 gap-4">
                                </div>
                        </div>

                        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4">RGP Key Metrics</h2>
                            
                            <div id="metrics-panel" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                </div>
                            
                            <h2 class="text-xl font-semibold text-gray-700 mb-4 pt-4 border-t border-gray-100">Top Vendors (Open RGPs)</h2>
                            <div id="vendor-panel" class="space-y-2">
                                </div>
                        </div>
                    </main>
                </div>
            `;
            // Call rendering functions for the inner parts
            renderNavigationButtons();
            renderAnalyticsPanel(data);
        }

        function renderNavigationButtons() {
            const buttonsData = [
                { label: "New RGP Entry", action: "New RGP Entry", className: "btn-new-rgp" },
                { label: "Return Entry", action: "Return Entry", className: "btn-return" },
                { label: "Pending RGP List", action: "Pending RGP List", className: "btn-pending" },
                { label: "Total RGP List", action: "Total RGP List", className: "btn-total" },
                { label: "Analytics", action: "Analytics", className: "btn-analytics" },
                { label: "Export Pending RGP List for Approval", action: "Export Pending RGP List for Approval", className: "btn-approval" } 
            ];

            const container = document.getElementById('navigation-panel');
            container.innerHTML = ''; 

            buttonsData.forEach(data => {
                const btn = document.createElement('button');
                btn.className = `${data.className} w-full text-white font-bold py-4 px-4 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01]`;
                btn.textContent = data.label;
                btn.onclick = () => handleButtonClick(data.action);
                container.appendChild(btn);
            });
        }

        function renderAnalyticsPanel(data) {
            const total = RGPManager.get_total_rgps(data);
            const open_rgps = RGPManager.get_open_rgps(data);
            const closed = RGPManager.get_closed_rgps(data);
            const overdue = RGPManager.get_overdue_rgps(data);
            const vendorCounts = RGPManager.get_vendor_open_counts(data);

            const metricsContainer = document.getElementById('metrics-panel');
            metricsContainer.innerHTML = '';

            const metrics = [
                { title: "Total RGPs", value: total, color: "text-blue-600", boxClass: "metric-box-base", action: "navigateToTotalRGPList('ALL')" },
                { title: "Open RGPs", value: open_rgps, color: "text-orange-500", boxClass: "metric-box-base", action: "navigateToTotalRGPList('OPEN')" },
                { title: "Closed RGPs", value: closed, color: "text-green-600", boxClass: "metric-box-base", action: "navigateToTotalRGPList('CLOSED')" },
                { title: "Overdue RGPs", value: overdue, color: "text-red-600", boxClass: "metric-box-overdue", action: "navigateToTotalRGPList('OPEN', true)" } 
            ];

            metrics.forEach(m => {
                const box = `
                    <div onclick="${m.action}" 
                         class="p-4 rounded-lg text-center shadow-inner ${m.boxClass} cursor-pointer transition duration-150 transform hover:shadow-lg hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 font-medium">${m.title}</p>
                        <p class="text-3xl font-extrabold mt-1 ${m.color}">${m.value}</p>
                    </div>
                `;
                metricsContainer.innerHTML += box;
            });

            // --- Vendor Bar Chart Rendering (Dashboard) ---
            const vendorContainer = document.getElementById('vendor-panel');
            vendorContainer.innerHTML = '';
            
            if (vendorCounts.length > 0) {
                const maxCount = vendorCounts.length > 0 ? vendorCounts[0][1] : 1; 
                
                vendorCounts.slice(0, 5).forEach(([vendor, count]) => {
                    const widthPercent = (count / maxCount) * 100;

                    const barChartItem = `
                        <div class="vendor-bar-container">
                            <div class="vendor-label truncate">${vendor}</div>
                            <div class="flex-grow bg-gray-200 rounded-md">
                                <div class="vendor-bar" style="width: ${widthPercent}%; background-color: #4f46e5;"></div>
                            </div>
                            <div class="vendor-count">${count}</div>
                        </div>
                    `;
                    vendorContainer.innerHTML += barChartItem;
                });
            } else {
                vendorContainer.innerHTML = '<p class="text-gray-500 italic p-3">No open RGPs to analyze vendors.</p>';
            }
        }


        // --- NEW RGP FORM VIEW RENDERING & LOGIC (MODIFIED: handleSaveNewRGP uses Apps Script) ---
        
        async function handleSaveNewRGP(event) {
            event.preventDefault(); // Stop form submission

            const form = event.target;
            const materials = [];
            let validationFailed = false;

            // 1. Gather & Validate Basic Fields
            if (!form['rgp-number'].value.trim() || !form['rgp-vendor'].value.trim() || !form['rgp-sent-by'].value.trim() || 
                !form['rgp-date'].value || !form['rgp-return-date'].value) {
                showMessage("Validation Error", "Please fill all mandatory RGP Header fields.", true);
                return;
            }

            const rgpNumberToCheck = form['rgp-number'].value.trim();

            // 2. Gather & Validate Material Fields
            const materialContainers = form.querySelectorAll('#material-entry-panel > div > div.grid-cols-4');
            if (materialContainers.length === 0) {
                showMessage("Validation Error", "Please add at least one material entry.", true);
                return;
            }

            materialContainers.forEach((container, index) => {
                const desc = container.querySelector(`[name="material-desc-${index}"]`).value.trim();
                const initialQtyStr = container.querySelector(`[name="initial-qty-${index}"]`).value;
                const initialQty = parseFloat(initialQtyStr);
                const unit = container.querySelector(`[name="unit-${index}"]`).value.trim();
                const remarks = container.querySelector(`[name="remarks-${index}"]`).value.trim();

                if (!desc || isNaN(initialQty) || initialQty <= 0 || !unit) {
                    validationFailed = true;
                    showMessage("Validation Error", `Material #${index + 1} has missing or invalid details.`, true);
                }

                materials.push({
                    id: index + 1, 
                    desc: desc,
                    initial_qty: initialQty,
                    returned_qty: 0, 
                    unit: unit,
                    remarks: remarks,
                });
            });

            if (validationFailed) return;

            // 3. Create new RGP object
            const newRGP = {
                action: 'saveNewRGP', 
                db_name: PRIMARY_DB_NAME, // Explicitly tell the script which DB to target
                status: "OPEN",
                sent_to: form['rgp-vendor'].value.trim(),
                sent_by: form['rgp-sent-by'].value.trim(),
                rgp_number: rgpNumberToCheck,
                issue_date: form['rgp-date'].value,
                expected_return_date: form['rgp-return-date'].value,
                materials: materials
            };

            // 4. Save to Apps Script
            try {
                // The script is expected to handle duplicate check and saving
                await callAppsScript('saveRGP', newRGP, 'POST'); 
                
                // Success actions: Show message & clear fields
                showMessage("Success", `RGP ${newRGP.rgp_number} saved successfully!`);
                form.reset();
                document.getElementById('material-entry-panel').innerHTML = '<p class="text-gray-500 italic p-4">Add materials using the button above.</p>';
                
                // Refresh data for dashboard metrics and lists
                fetchRGPData();
                
            } catch (e) {
                showMessage("Database Error", `Failed to save RGP ${newRGP.rgp_number}. Reason: ${e.message}`, true);
            }
        }

        function renderNewRGPView() {
            const contentDiv = document.getElementById('main-content');
            contentDiv.innerHTML = `
                <div class="grid grid-cols-2 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">New RGP Entry</h2>
                    <div class="justify-self-end">
                        <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home
                        </button>
                    </div>
                </div>

                <form id="new-rgp-form" onsubmit="handleSaveNewRGP(event)" class="bg-white p-6 rounded-xl shadow-lg space-y-6">

                    <h3 class="text-xl font-medium text-gray-700 border-b pb-2">RGP Header Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                        
                        <label class="block">
                            <span class="text-gray-700">RGP Number <span class="text-red-500">*</span></span>
                            <input type="text" id="rgp-number" name="rgp-number" required placeholder="e.g. RGP/2024/001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </label>
                        
                        <label class="block">
                            <span class="text-gray-700">Sent To (Vendor) <span class="text-red-500">*</span></span>
                            <input type="text" id="rgp-vendor" name="rgp-vendor" required placeholder="Vendor Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </label>

                        <label class="block">
                            <span class="text-gray-700">Sent By (User) <span class="text-red-500">*</span></span>
                            <input type="text" id="rgp-sent-by" name="rgp-sent-by" required placeholder="Your Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </label>

                        <label class="block">
                            <span class="text-gray-700">Issue Date <span class="text-red-500">*</span></span>
                            <input type="date" id="rgp-date" name="rgp-date" value="${dateOffset(0)}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </label>

                        <label class="block">
                            <span class="text-gray-700">Expected Return Date <span class="text-red-500">*</span></span>
                            <input type="date" id="rgp-return-date" name="rgp-return-date" value="${dateOffset(30)}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </label>
                    </div>

                    <h3 class="text-xl font-medium text-gray-700 border-b pb-2 pt-4 flex justify-between items-center">
                        <span>Material Details</span>
                        <button type="button" onclick="addMaterialEntry()" class="bg-indigo-500 text-white text-sm font-medium px-3 py-1.5 rounded-lg hover:bg-indigo-600 transition duration-150">
                            + Add Item
                        </button>
                    </h3>

                    <div id="material-entry-panel" class="space-y-4">
                        <p class="text-gray-500 italic p-4">Add materials using the button above.</p>
                    </div>

                    <div class="flex justify-end pt-4 border-t">
                        <button type="submit" class="btn-new-rgp text-white px-6 py-3 rounded-xl shadow-md transition duration-150 hover:bg-indigo-700">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save New RGP
                        </button>
                    </div>
                </form>
            `;
            // Add initial empty material entry when the view is rendered
            addMaterialEntry(true); 
        }

        let materialCount = 0;
        function addMaterialEntry(isInitial = false) {
            const container = document.getElementById('material-entry-panel');
            if (isInitial && materialCount === 0) {
                container.innerHTML = ''; // Clear initial placeholder text
            }
            
            const i = materialCount++;
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'border border-gray-200 p-4 rounded-lg bg-gray-50 space-y-4';
            entryDiv.setAttribute('data-material-id', i);
            
            entryDiv.innerHTML = `
                <div class="flex justify-between items-center border-b pb-2">
                    <h4 class="text-sm font-semibold text-gray-700">Material Item #${i + 1}</h4>
                    <button type="button" onclick="removeMaterialEntry(${i})" class="text-red-500 hover:text-red-700 text-sm font-medium ${materialCount === 1 && isInitial ? 'hidden' : ''}">
                        Remove
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-10 gap-4">
                    <label class="block md:col-span-4">
                        <span class="text-gray-700 text-sm">Description <span class="text-red-500">*</span></span>
                        <input type="text" name="material-desc-${i}" required placeholder="Material Description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                    </label>
                    <label class="block md:col-span-2">
                        <span class="text-gray-700 text-sm">Initial Qty <span class="text-red-500">*</span></span>
                        <input type="number" name="initial-qty-${i}" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                    </label>
                    <label class="block md:col-span-2">
                        <span class="text-gray-700 text-sm">Unit <span class="text-red-500">*</span></span>
                        <input type="text" name="unit-${i}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                    </label>
                    <label class="block md:col-span-2">
                        <span class="text-gray-700 text-sm">Remarks</span>
                        <input type="text" name="remarks-${i}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                    </label>
                </div>
            `;
            container.appendChild(entryDiv);
            
            // Re-check visibility of remove buttons after adding
            updateRemoveButtonVisibility();
        }

        function removeMaterialEntry(idToRemove) {
            const container = document.getElementById('material-entry-panel');
            const elementToRemove = container.querySelector(`[data-material-id="${idToRemove}"]`);
            
            if (elementToRemove) {
                elementToRemove.remove();
                materialCount--; // Only decrement if an item was actually removed
                
                // Re-index remaining elements to maintain form data integrity 
                // (Though not strictly necessary for this simple form, it's good practice)
                const remainingEntries = container.querySelectorAll('[data-material-id]');
                remainingEntries.forEach((entry, index) => {
                    entry.setAttribute('data-material-id', index);
                    // Update header
                    entry.querySelector('h4').textContent = `Material Item #${index + 1}`;
                    // Update input names for fields that might be used server-side
                    entry.querySelectorAll('input').forEach(input => {
                        input.name = input.name.replace(/-\d+$/, `-${index}`);
                    });
                    // Update remove button onclick handler
                    const removeBtn = entry.querySelector('button[onclick^="removeMaterialEntry"]');
                    if (removeBtn) {
                        removeBtn.setAttribute('onclick', `removeMaterialEntry(${index})`);
                    }
                });
            }
            
            // If all materials are removed, show placeholder
            if (materialCount === 0) {
                 container.innerHTML = '<p class="text-gray-500 italic p-4">Add materials using the button above.</p>';
            }
            
            updateRemoveButtonVisibility();
        }

        function updateRemoveButtonVisibility() {
             const container = document.getElementById('material-entry-panel');
             const removeButtons = container.querySelectorAll('button[onclick^="removeMaterialEntry"]');
             
             // If there is only one item, hide the remove button on it
             if (removeButtons.length === 1) {
                 removeButtons[0].classList.add('hidden');
             } else {
                 removeButtons.forEach(btn => btn.classList.remove('hidden'));
             }
        }


        // --- RETURN ENTRY VIEW RENDERING & LOGIC (MODIFIED: handleSaveReturnEntry uses Apps Script) ---

        /**
         * Handles the lookup of the RGP Number entered in the form.
         * Fetches data if not already selected or if a new number is entered.
         */
        async function handleRGPLookup(event) {
            if (event) event.preventDefault();
            
            const rgpNumberInput = document.getElementById('rgp-number-lookup');
            const rgpNumber = rgpNumberInput.value.trim().toUpperCase();
            
            if (rgpNumber === selectedRGPNumber) {
                // If the user hits enter on the same RGP number, just re-render
                renderReturnEntryDynamicDetails();
                return;
            }

            // Clear previous state and show loading
            selectedRGP = null;
            selectedRGPNumber = rgpNumber;
            renderReturnEntryDynamicDetails("Looking up RGP..."); 
            
            if (!rgpNumber) {
                renderReturnEntryDynamicDetails(); // Render empty state
                return;
            }

            // Find RGP in local data (assumes fetchRGPData keeps data fresh)
            const rgp = RGPManager.find_rgp_by_number(rgpNumber);
            
            if (rgp) {
                selectedRGP = rgp;
            } 
            
            // Render the details based on the lookup result
            renderReturnEntryDynamicDetails(); 
        }

        /**
         * Handles the saving of the return entry data by calling the Apps Script.
         */
        async function handleSaveReturnEntry(event) {
            event.preventDefault();
            if (!selectedRGP) {
                showMessage("Error", "No RGP selected for return entry.", true);
                return;
            }

            const form = document.getElementById('return-entry-form');
            const returnEntries = [];
            let validationFailed = false;
            let totalReturnQty = 0;

            // 1. Validate Return Quantities
            selectedRGP.materials.forEach(material => {
                const input = form.querySelector(`input[data-material-id="${material.id}"]`);
                if (!input) return;

                const returnQty = parseInt(input.value) || 0;
                const outstanding = material.initial_qty - material.returned_qty;

                if (returnQty < 0 || returnQty > outstanding) {
                    validationFailed = true;
                    showMessage("Validation Error", `Material: ${material.desc}. Return quantity (${returnQty}) must be between 0 and outstanding quantity (${outstanding}).`, true);
                }

                if (returnQty > 0) {
                    returnEntries.push({
                        material_id: material.id,
                        return_qty: returnQty
                    });
                    totalReturnQty += returnQty;
                }
            });

            if (validationFailed) return;

            if (totalReturnQty === 0) {
                showMessage("Validation Error", "Please enter at least one material quantity to return.", true);
                return;
            }

            // 2. Prepare payload for Apps Script
            const returnData = {
                action: 'saveReturnEntry',
                db_name: PRIMARY_DB_NAME,
                rgp_id: selectedRGP.id, // Use the unique ID for lookup on the backend
                rgp_number: selectedRGP.rgp_number, 
                return_date: form['actual-return-date'].value,
                entries: returnEntries
            };

            // 3. Save to Apps Script
            try {
                // The script is expected to update the material returned_qty and RGP status if all are closed
                await callAppsScript('saveReturnEntry', returnData, 'POST'); 
                
                // Success actions: Show message & clear fields
                showMessage("Success", `Return entry saved successfully for RGP ${selectedRGP.rgp_number}.`);
                
                // Reset form state and refresh data
                selectedRGP = null;
                selectedRGPNumber = null;
                document.getElementById('rgp-number-lookup').value = '';

                // Refresh data to update dashboard metrics and lists
                fetchRGPData();

            } catch (e) {
                showMessage("Database Error", `Failed to save return entry for RGP ${selectedRGP.rgp_number}. Reason: ${e.message}`, true);
            }
        }


        /**
         * Renders the material list table for the return entry view. (UNCHANGED)
         * @param {object|null} rgp - The selected RGP object.
         */
        function renderReturnMaterialList(rgp) {
            const container = document.getElementById('rgp-material-list-container');
            if (!container) return;

            if (!rgp || rgp.status.toUpperCase() === 'CLOSED') {
                container.innerHTML = rgp && rgp.status.toUpperCase() === 'CLOSED' ? 
                    '<p class="text-lg text-green-600 font-semibold p-4 bg-green-50 rounded-lg">This RGP is already CLOSED.</p>' :
                    '<p class="text-gray-500 italic p-4">Please enter a valid RGP Number to see material details.</p>';
                return;
            }

            const materialsHtml = `
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Initial Qty</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Returned Qty</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Outstanding</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Return Now</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rgp.materials.map(material => {
                                const outstanding = material.initial_qty - material.returned_qty;
                                if (outstanding <= 0) return ''; // Skip fully returned materials
                                
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${material.desc} (${material.unit})</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${material.initial_qty}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-green-600 font-medium">${material.returned_qty}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-bold text-red-600">${outstanding}</td>
                                        <td class="px-6 py-2 whitespace-nowrap text-sm text-center">
                                            <input type="number" 
                                                min="0" 
                                                max="${outstanding}" 
                                                value="0" 
                                                data-material-id="${material.id}"
                                                class="w-20 text-center rounded-md border-gray-300 shadow-sm p-1 text-sm focus:ring-green-500 focus:border-green-500">
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = materialsHtml;
        }

        /**
         * Renders the RGP details and material list based on the selectedRGP state.
         * @param {string} [loadingMessage=null] - Optional loading message to display.
         */
        function renderReturnEntryDynamicDetails(loadingMessage = null) {
            const rgp = selectedRGP;
            const rgpNumber = selectedRGPNumber || '';
            
            let rgpDetailsHtml = '';
            let saveButtonDisabled = true;
            let saveButtonText = 'Save Return Entry';

            if (loadingMessage) {
                rgpDetailsHtml = `<div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 font-medium">${loadingMessage}</div>`;
                saveButtonText = 'Saving...';
                
            } else if (rgp) {
                saveButtonDisabled = rgp.status.toUpperCase() === 'CLOSED';
                saveButtonText = saveButtonDisabled ? 'RGP Already Closed' : 'Save Return Entry';
                
                // 1. RGP Details Header
                rgpDetailsHtml = `
                    <h3 class="text-xl font-medium text-gray-700 border-b pb-2 mb-4">RGP Header Details</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <p class="font-medium text-gray-700">RGP No:</p><p class="font-bold text-gray-900">${rgp.rgp_number}</p>
                        <p class="font-medium text-gray-700">Issue Date:</p><p class="font-bold text-gray-900">${formatDateDisplay(rgp.issue_date)}</p>
                        <p class="font-medium text-gray-700">Vendor:</p><p class="font-bold text-gray-900 truncate" title="${rgp.sent_to}">${rgp.sent_to}</p>
                        <p class="font-medium text-gray-700">Expected Return:</p><p class="font-bold text-gray-900">${formatDateDisplay(rgp.expected_return_date)}</p>
                        <p class="font-medium text-gray-700">Sent By:</p><p class="font-bold text-gray-900">${rgp.sent_by}</p>
                        <p class="font-medium text-gray-700">Status:</p><p class="font-bold text-${rgp.status.toUpperCase() === 'CLOSED' ? 'green-600' : 'red-600'}">${rgp.status.toUpperCase()}</p>
                    </div>`;
            } else if (rgpNumber.length > 0) {
                // RGP not found
                rgpDetailsHtml = `<div class="bg-yellow-50 p-4 rounded-lg text-sm text-yellow-800 font-medium">RGP Number ${rgpNumber} not found in the database.</div>`;
            } else {
                rgpDetailsHtml = `<div class="bg-gray-200 p-4 rounded-lg text-sm text-gray-700 font-medium">Enter an RGP Number to see details.</div>`;
            }

            // 3. Update UI
            document.getElementById('rgp-details-panel').innerHTML = rgpDetailsHtml;
            renderReturnMaterialList(rgp);

            const saveButton = document.getElementById('save-return-btn');
            if (saveButton) {
                saveButton.textContent = saveButtonText;
                saveButton.disabled = saveButtonDisabled;
                saveButton.className = saveButtonDisabled ? 
                    'bg-gray-400 text-white px-6 py-3 rounded-xl shadow-md cursor-not-allowed' : 
                    'bg-green-600 text-white px-6 py-3 rounded-xl shadow-md hover:bg-green-700 transition duration-150';
            }
        }

        function renderReturnEntryView() {
            const contentDiv = document.getElementById('main-content');
            
            contentDiv.innerHTML = `
                <div class="grid grid-cols-2 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Return Entry</h2>
                    <div class="justify-self-end">
                        <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                    
                    <h3 class="text-xl font-medium text-gray-700 border-b pb-2">RGP Lookup</h3>
                    <form onsubmit="handleRGPLookup(event)" class="flex space-x-4 items-end">
                        <label class="block flex-grow">
                            <span class="text-gray-700">RGP Number <span class="text-red-500">*</span></span>
                            <input type="text" id="rgp-number-lookup" value="${selectedRGPNumber || ''}" required placeholder="Enter RGP Number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 uppercase">
                        </label>
                        <button type="submit" class="bg-indigo-500 text-white px-4 py-2.5 rounded-xl shadow-md hover:bg-indigo-600 transition duration-150 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Lookup
                        </button>
                    </form>
                    
                    <div id="rgp-details-panel" class="p-4 border border-gray-100 rounded-lg">
                        </div>

                    <h3 class="text-xl font-medium text-gray-700 border-b pb-2 pt-4">Return Materials Entry</h3>
                    <form id="return-entry-form" onsubmit="handleSaveReturnEntry(event)" class="space-y-4">
                        
                        <label class="block max-w-sm">
                            <span class="text-gray-700">Actual Return Date <span class="text-red-500">*</span></span>
                            <input type="date" id="actual-return-date" name="actual-return-date" value="${dateOffset(0)}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </label>

                        <div id="rgp-material-list-container" class="bg-white border border-gray-200 rounded-lg shadow-inner">
                             <p class="text-gray-500 italic p-4">Material list will appear here after lookup.</p>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" id="save-return-btn" disabled class="bg-gray-400 text-white px-6 py-3 rounded-xl shadow-md cursor-not-allowed">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Return Entry
                            </button>
                        </div>
                    </form>
                </div>
            `;
            // Initial render of dynamic content (details and material list)
            renderReturnEntryDynamicDetails();
        }

        // --- RGP LIST UTILITY FUNCTIONS (UNCHANGED) ---

        /**
         * Converts RGP data (which contains a materials array) into a flattened
         * array of rows where each material is a separate row, used for table rendering and export.
         * @param {Array<Object>} data - Array of RGP objects.
         * @returns {Array<Object>} Flattened array of row data.
         */
        function dataToRowData(data) {
            const rowData = [];
            data.forEach(rgp => {
                const materials = rgp.materials.filter(m => m.initial_qty - m.returned_qty > 0 || rgp.status.toUpperCase() !== 'OPEN'); // Filter to show outstanding for OPEN, all for others
                
                // If there are no materials (shouldn't happen) or all returned (for CLOSED)
                if (materials.length === 0 && rgp.status.toUpperCase() !== 'OPEN') {
                    // Create a single row for the RGP with default material info
                    rowData.push({
                         rgpNumber: rgp.rgp_number,
                         vendor: rgp.sent_to,
                         sentBy: rgp.sent_by,
                         issueDate: formatDateDisplay(rgp.issue_date),
                         expectedReturnDate: formatDateDisplay(rgp.expected_return_date),
                         status: rgp.status,
                         daysOpen: rgp.days_open,
                         materialDesc: 'N/A (All Items Closed)',
                         initialQty: 0,
                         returnedQty: 0,
                         outstandingQty: 0,
                         remarks: '',
                         uniqueId: rgp.id,
                         rowSpan: 1,
                         isMainRow: true
                    });
                    return;
                } else if (materials.length === 0 && rgp.status.toUpperCase() === 'OPEN') {
                     // Should not happen for an OPEN RGP unless initial data is bad
                     return;
                }

                materials.forEach((material, index) => {
                    const outstanding = material.initial_qty - material.returned_qty;
                    
                    rowData.push({
                        rgpNumber: rgp.rgp_number,
                        vendor: rgp.sent_to,
                        sentBy: rgp.sent_by,
                        issueDate: formatDateDisplay(rgp.issue_date),
                        expectedReturnDate: formatDateDisplay(rgp.expected_return_date),
                        status: rgp.status,
                        daysOpen: rgp.days_open,
                        materialDesc: `${material.desc} (${material.unit})`,
                        initialQty: material.initial_qty,
                        returnedQty: material.returned_qty,
                        outstandingQty: outstanding,
                        remarks: material.remarks,
                        uniqueId: rgp.id,
                        rowSpan: index === 0 ? materials.length : 0, // Mark the first material row with the total row span
                        isMainRow: index === 0 // Flag for the row that holds main RGP details
                    });
                });
            });
            return rowData;
        }

        /**
         * Renders the HTML table body from flattened row data.
         * @param {Array<Object>} rows - Flattened array of row data.
         * @param {string} tbodyId - ID of the tbody element.
         */
        function renderRGPTableBody(rows, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;
            tbody.innerHTML = ''; // Clear previous content

            if (rows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-6 py-4 text-center text-gray-500 italic">No matching RGP records found.</td>
                    </tr>
                `;
                return;
            }

            rows.forEach(row => {
                const statusColor = row.status.toUpperCase() === 'CLOSED' ? 'text-green-600' : 
                                    (row.status.toUpperCase() === 'OPEN' && row.outstandingQty === 0) ? 'text-green-600' :
                                    'text-red-600';
                
                // Color days open if overdue
                let daysOpenCell = 'text-gray-700';
                if (row.status.toUpperCase() === 'OPEN') {
                    // Check if RGP is overdue (30 days past expected return date)
                    const expectedReturn = parseDate(row.expectedReturnDate.split('/').reverse().join('-')); // Convert DD/MM/YYYY back to Date object
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); 

                    const thirtyDaysAfterReturn = new Date(expectedReturn);
                    thirtyDaysAfterReturn.setDate(expectedReturn.getDate() + 30);
                    
                    if (today > thirtyDaysAfterReturn) {
                        daysOpenCell = 'text-red-600 font-extrabold';
                    }
                }
                
                
                let rgpNumberCell = '';
                let vendorCell = '';
                let sentByCell = '';
                let issueDateCell = '';
                let expectedReturnDateCell = '';
                let statusCell = '';
                let daysOpenCellHtml = '';
                let actionCell = '';

                if (row.isMainRow) {
                    rgpNumberCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${row.rgpNumber}</td>`;
                    vendorCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 truncate" title="${row.vendor}">${row.vendor}</td>`;
                    sentByCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.sentBy}</td>`;
                    issueDateCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${row.issueDate}</td>`;
                    expectedReturnDateCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${row.expectedReturnDate}</td>`;
                    statusCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-center ${statusColor}">${row.status.toUpperCase()}</td>`;
                    daysOpenCellHtml = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-center ${daysOpenCell}">${row.daysOpen}</td>`;
                    actionCell = `<td rowspan="${row.rowSpan}" class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editRGP('${row.rgpNumber}')" title="Go to Return Entry" class="text-indigo-600 hover:text-indigo-900 disabled:text-gray-400 disabled:cursor-not-allowed" ${row.status.toUpperCase() === 'CLOSED' ? 'disabled' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </button>
                    </td>`;
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 ${row.isMainRow ? 'border-t-2 border-gray-100' : ''}">
                        ${rgpNumberCell}
                        ${vendorCell}
                        ${sentByCell}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.materialDesc}</td>
                        ${issueDateCell}
                        ${expectedReturnDateCell}
                        ${statusCell}
                        ${daysOpenCellHtml}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-700">${row.initialQty}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-green-600 font-medium">${row.returnedQty}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-bold ${row.outstandingQty > 0 ? 'text-red-600' : 'text-gray-500'}">${row.outstandingQty}</td>
                        ${actionCell}
                    </tr>
                `;
            });
        }

        // --- PENDING RGP LIST VIEW RENDERING & FILTERING (UNCHANGED) ---

        function updateRGPListUI(data, tbodyId, titleId) {
            const rows = dataToRowData(data);
            renderRGPTableBody(rows, tbodyId);
            
            // Update header with count
            const titleElement = document.getElementById(titleId);
            if (titleElement) {
                const totalCount = [...new Set(data.map(r => r.rgp_number))].length;
                titleElement.textContent = `Pending RGP List (${totalCount} Unique RGPs)`;
            }
        }

        function renderPendingRGPListView() {
            const contentDiv = document.getElementById('main-content');
            
            // Filter is simplified since we only show OPEN items in this view.
            const dataToDisplay = pendingRGPData.filter(rgp => rgp.materials.some(m => m.initial_qty > m.returned_qty));
            filteredRGPData = dataToDisplay;

            contentDiv.innerHTML = `
                <div class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 id="pending-list-title" class="text-2xl font-semibold text-gray-800 justify-self-start">Pending RGP List</h2>
                    <div class="justify-self-center">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain">
                    </div>
                    <div class="justify-self-end space-x-4">
                         <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home
                        </button>
                         <button onclick="exportPendingRGPList()" class="bg-green-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-green-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> Export
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RGP No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor / Sent To</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sent By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material Desc</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Exp. Return Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Days Open</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Initial Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Returned Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Outstanding Qty</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="rgp-list-tbody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            updateRGPListUI(dataToDisplay, 'rgp-list-tbody', 'pending-list-title');
        }

        // --- TOTAL RGP LIST VIEW RENDERING & FILTERING (UNCHANGED) ---

        function filterTotalRGPData() {
            const filterText = document.getElementById('total-rgp-filter-text').value.trim().toUpperCase();
            const statusFilter = document.getElementById('total-rgp-status-filter').value.toUpperCase();
            const overdueFilterCheckbox = document.getElementById('total-rgp-overdue-filter');
            const overdueFilter = overdueFilterCheckbox ? overdueFilterCheckbox.checked : window.totalRGPOverdueFilter; 

            // Update global state from UI elements
            window.totalRGPFilterText = filterText;
            window.totalRGPStatusFilter = statusFilter;
            window.totalRGPOverdueFilter = overdueFilter; 
            
            let dataToFilter = [...currentRGPData];
            
            // 1. Status Filter (unless an analytics filter is active)
            if (!window.analyticsFilterType || window.totalRGPStatusFilter !== 'OPEN') {
                 if (statusFilter !== 'ALL') {
                    dataToFilter = dataToFilter.filter(r => r.status.toUpperCase() === statusFilter);
                }
            }


            // 2. Overdue Filter (only applies to OPEN RGPs)
            if (overdueFilter && statusFilter === 'OPEN') {
                const today = new Date();
                today.setHours(0, 0, 0, 0); 
                
                dataToFilter = dataToFilter.filter(r => {
                     if (!r.expected_return_date) return false;

                    try {
                        const expectedReturnDate = parseDate(r.expected_return_date);
                        // RGP is considered overdue if it's 30 days past the expected return date.
                        const thirtyDaysAfterReturn = new Date(expectedReturnDate);
                        thirtyDaysAfterReturn.setDate(expectedReturnDate.getDate() + 30);
                        
                        return today > thirtyDaysAfterReturn;

                    } catch (e) {
                        return false;
                    }
                });
            }


            // 3. Text/Search Filter
            const filteredData = dataToFilter.filter(rgp => {
                const textMatch = !filterText ||
                    rgp.rgp_number.toUpperCase().includes(filterText) ||
                    (rgp.sent_to && rgp.sent_to.toUpperCase().includes(filterText)) ||
                    (rgp.sent_by && rgp.sent_by.toUpperCase().includes(filterText)) ||
                    rgp.materials.some(m => m.desc.toUpperCase().includes(filterText));
                    
                // 4. Analytics Filter (overrides Status/Text filter if active and checking OPEN items)
                if (window.analyticsFilterType === 'vendor' && window.analyticsFilterValue) {
                    return rgp.status.toUpperCase() === 'OPEN' && 
                           (rgp.sent_to || "").toUpperCase() === window.analyticsFilterValue.toUpperCase();
                } else if (window.analyticsFilterType === 'user' && window.analyticsFilterValue) {
                    return rgp.status.toUpperCase() === 'OPEN' && 
                           (rgp.sent_by || "").toUpperCase() === window.analyticsFilterValue.toUpperCase();
                } else {
                    return textMatch;
                }
            });

            window.filteredTotalRGPData = filteredData;
            updateRGPListUI(window.filteredTotalRGPData, 'total-rgp-list-tbody', 'total-list-title');
        }

        function renderTotalRGPListView() {
            const contentDiv = document.getElementById('main-content');
            
            let analyticsStatusMessage = '';
            if (window.analyticsFilterType === 'vendor' && window.analyticsFilterValue) {
                analyticsStatusMessage = `<p class="text-indigo-600 font-bold mb-4 bg-indigo-100 p-3 rounded-lg border border-indigo-200">NOTE: Showing only Open RGPs for Vendor: <strong>${window.analyticsFilterValue}</strong>. <button onclick="navigateToTotalRGPList('OPEN')" class="text-indigo-800 underline ml-2">Clear Filter</button></p>`;
            } else if (window.analyticsFilterType === 'user' && window.analyticsFilterValue) {
                 analyticsStatusMessage = `<p class="text-purple-600 font-bold mb-4 bg-purple-100 p-3 rounded-lg border border-purple-200">NOTE: Showing only Open RGPs for User: <strong>${window.analyticsFilterValue}</strong>. <button onclick="navigateToTotalRGPList('OPEN')" class="text-purple-800 underline ml-2">Clear Filter</button></p>`;
            } else {
                 analyticsStatusMessage = '';
            }
            
            const overdueStatusMessage = window.totalRGPOverdueFilter ? 
                `<p class="text-red-600 font-bold mb-4 bg-red-100 p-3 rounded-lg border border-red-200">FILTER ACTIVE: Showing only Overdue Open RGPs (30 days past expected return date).</p>` : '';


            contentDiv.innerHTML = `
                <div class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 id="total-list-title" class="text-2xl font-semibold text-gray-800 justify-self-start">Total RGP List</h2>
                    <div class="justify-self-center">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain">
                    </div>
                    <div class="justify-self-end space-x-4">
                         <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home
                        </button>
                         <button onclick="exportTotalRGPList()" class="bg-green-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-green-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> Export
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    ${analyticsStatusMessage}
                    ${overdueStatusMessage}
                    <div class="flex space-x-4">
                        <input type="text" id="total-rgp-filter-text" placeholder="Filter by RGP No., Vendor, User or Material..." value="${window.totalRGPFilterText}" class="block w-1/3 rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2" oninput="filterTotalRGPData()">
                        <select id="total-rgp-status-filter" class="block w-1/6 rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2" onchange="filterTotalRGPData()">
                            <option value="ALL" ${window.totalRGPStatusFilter === 'ALL' ? 'selected' : ''}>ALL RGPs</option>
                            <option value="OPEN" ${window.totalRGPStatusFilter === 'OPEN' ? 'selected' : ''}>OPEN</option>
                            <option value="CLOSED" ${window.totalRGPStatusFilter === 'CLOSED' ? 'selected' : ''}>CLOSED</option>
                        </select>
                        <label for="total-rgp-overdue-filter" class="flex items-center space-x-2 w-1/6 p-2">
                             <input type="checkbox" id="total-rgp-overdue-filter" ${window.totalRGPOverdueFilter ? 'checked' : ''} onchange="filterTotalRGPData()" 
                                 class="rounded border-gray-300 text-red-600 shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50">
                             <span class="text-sm font-medium text-gray-700">Show Overdue Only</span>
                        </label>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RGP No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor / Sent To</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sent By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material Desc</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Exp. Return Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Days Open</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Initial Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Returned Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Outstanding Qty</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="total-rgp-list-tbody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            // Ensure the correct filtered data is shown on first render
            filterTotalRGPData();
            
            // If the view was navigated to from a metric, ensure the title is updated
             const totalCount = [...new Set(window.filteredTotalRGPData.map(r => r.rgp_number))].length;
             document.getElementById('total-list-title').textContent = `Total RGP List (${totalCount} Unique RGPs)`;
        }

        // --- APPROVAL RGP LIST VIEW RENDERING (NEW) ---

        function updateApprovalRGPListUI(data) {
            const rows = dataToRowData(data); // Re-use the dataToRowData function
            renderRGPTableBody(rows, 'approval-list-tbody');
            
            // Update header with count
            const titleElement = document.getElementById('approval-list-title');
            if (titleElement) {
                const totalCount = [...new Set(data.map(r => r.rgp_number))].length;
                titleElement.textContent = `RGP List for Approval (${totalCount} Unique RGPs)`;
            }
        }
        
        function renderApprovalRGPListView() {
            const contentDiv = document.getElementById('main-content');
            
            // The data is pre-filtered by RGPManager.get_approval_rgp_data (open, overdue OR 30 days old)
            // It also excludes fully returned items by filtering the materials within dataToRowData
            const dataToDisplay = window.approvalRGPData.filter(rgp => rgp.materials.some(m => m.initial_qty > m.returned_qty));
            window.filteredApprovalRGPData = dataToDisplay;
            
            contentDiv.innerHTML = `
                <div class="grid grid-cols-3 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 id="approval-list-title" class="text-2xl font-semibold text-gray-800 justify-self-start">RGP List for Approval</h2>
                    <div class="justify-self-center">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/gpwAAAArlBMVEVHcEwABwAABQAABQAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgAABgD///8AAAC1G048AAAAPHRSTlMAECAwQFBgcICQoLCwwNDxARFRYXGBkaGxwdHh8gISIjJDY4Ojs9P0BBQ0RFR0hMU1dbXmFnaW9xdXh7f4u+K/UAAAFxSURBVHja7dzbVtsgFAZgAAEEiCBBgASBBOJ4wO3//6XlP0q9k+iWJmK3vud92n1d7xXQ0dHR0dHR0dHR0dHR0dHRCw5zNndh3t4s03j/x5057NvdhXmH27B/d9m/u+zP+x73c9+H8w53ce/tNn//z9wP5h3uu93O9/zcv+M+3Me6h+v7/pW797p24f9wP/7Rvd/1+R5Hw73Xpwu+P+29vW/7+yv+P+5z9+t+39l/hvud+/q+72x/+f9w/7P97X/f2V/h/uf729/3tv/u/sP+4/vb7/2H/3/9J/e3v/u+/+/+w/w33N8f7tNn/vX/3f2X/7fX+7Tf/5v3D/7ff6dJv++7+/+w/93693f+33//+tH97e/e7p6Oj/N74BfLw/kXkPAAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyNC0wMi0wNlQxODoyNjo1NyswMDowMNn1J50AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjQtMDItMDZUMTg6MjY6NTcrMDA6MDAD1L2oAAAAKHRFWHRkYXRlOnRpbWVzdGFtcD日時MjAyNC0wMi0wNlQxODoyNjo1NyswMDowMCE0L4cAAAAASUVORK5CYII=" alt="Britannia Logo" class="h-12 w-auto object-contain">
                    </div>
                    <div class="justify-self-end space-x-4">
                         <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home
                        </button>
                         <button onclick="exportApprovalRGPList()" class="bg-green-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-green-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> Export
                        </button>
                    </div>
                </div>
                
                <div class="bg-red-50 p-4 rounded-xl shadow-lg border border-red-200 mb-6">
                    <p class="font-bold text-red-800">Note: This list includes all OPEN RGPs that are either past their expected return date OR are more than 30 days old from the Issue Date.</p>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RGP No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor / Sent To</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sent By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material Desc</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Exp. Return Date</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Days Open</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Initial Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Returned Qty</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Outstanding Qty</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="approval-list-tbody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            updateApprovalRGPListUI(dataToDisplay);
        }

        // --- ANALYTICS VIEW RENDERING (NEW) ---

        function renderUserBarChart(userCounts) {
            let html = '';
            if (userCounts.length === 0) {
                 return '<p class="text-gray-500 italic p-3">No open RGPs to analyze users.</p>';
            }

            const maxCount = userCounts[0][1] > 0 ? userCounts[0][1] : 1;
            
            userCounts.slice(0, 5).forEach(([user, count]) => {
                const widthPercent = (count / maxCount) * 100;

                html += `
                    <div onclick="navigateToAnalyticsFilter('user', '${user}')" class="vendor-bar-container cursor-pointer hover:bg-purple-50 p-1 rounded transition duration-150">
                        <div class="vendor-label truncate">${user}</div>
                        <div class="flex-grow bg-gray-200 rounded-md">
                            <div class="vendor-bar" style="width: ${widthPercent}%; background-color: #8b5cf6;"></div>
                        </div>
                        <div class="vendor-count">${count}</div>
                    </div>
                `;
            });
            return html;
        }

        function renderVendorBarChart(vendorCounts) {
            let html = '';
            if (vendorCounts.length === 0) {
                 return '<p class="text-gray-500 italic p-3">No open RGPs to analyze vendors.</p>';
            }

            const maxCount = vendorCounts[0][1] > 0 ? vendorCounts[0][1] : 1;
            
            vendorCounts.slice(0, 5).forEach(([vendor, count]) => {
                const widthPercent = (count / maxCount) * 100;

                html += `
                    <div onclick="navigateToAnalyticsFilter('vendor', '${vendor}')" class="vendor-bar-container cursor-pointer hover:bg-indigo-50 p-1 rounded transition duration-150">
                        <div class="vendor-label truncate">${vendor}</div>
                        <div class="flex-grow bg-gray-200 rounded-md">
                            <div class="vendor-bar" style="width: ${widthPercent}%; background-color: #4f46e5;"></div>
                        </div>
                        <div class="vendor-count">${count}</div>
                    </div>
                `;
            });
            return html;
        }

        function renderAnalyticsView(data) {
            const contentDiv = document.getElementById('main-content');
            
            const totalRgpCount = RGPManager.get_total_rgps(data);
            const openRgpCount = RGPManager.get_open_rgps(data);
            const closedRgpCount = RGPManager.get_closed_rgps(data);
            const overdueRgpCount = RGPManager.get_overdue_rgps(data);
            
            // Stats based on OPEN RGPs
            const openRGPData = data.filter(r => r.status.toUpperCase() === "OPEN");
            const avgDaysOpen = RGPManager.get_avg_days_open(openRGPData);
            const totalOutstandingQty = RGPManager.get_total_outstanding_qty(openRGPData);
            const topVendors = RGPManager.get_vendor_open_counts(openRGPData);
            const topUsers = RGPManager.get_user_open_counts(openRGPData);

            contentDiv.innerHTML = `
                <div class="grid grid-cols-2 items-center p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">RGP Analytics</h2>
                    <div class="justify-self-end">
                         <button onclick="goHome()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div onclick="navigateToTotalRGPList('ALL')" class="p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-150 border-l-4 border-blue-500 bg-blue-50">
                        <p class="text-sm text-gray-500 font-medium">Total RGPs</p>
                        <p class="text-3xl font-extrabold mt-1 text-blue-600">${totalRgpCount}</p>
                    </div>
                    <div onclick="navigateToTotalRGPList('OPEN')" class="p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-150 border-l-4 border-orange-500 bg-orange-50">
                        <p class="text-sm text-gray-500 font-medium">Open RGPs</p>
                        <p class="text-3xl font-extrabold mt-1 text-orange-600">${openRgpCount}</p>
                    </div>
                    <div onclick="navigateToTotalRGPList('OPEN', true)" class="p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-150 border-l-4 border-red-500 bg-red-50">
                        <p class="text-sm text-gray-500 font-medium">Overdue RGPs</p>
                        <p class="text-3xl font-extrabold mt-1 text-red-600">${overdueRgpCount}</p>
                    </div>
                     <div onclick="navigateToTotalRGPList('CLOSED')" class="p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-150 border-l-4 border-green-500 bg-green-50">
                        <p class="text-sm text-gray-500 font-medium">Closed RGPs</p>
                        <p class="text-3xl font-extrabold mt-1 text-green-600">${closedRgpCount}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Open RGP KPIs</h3>
                        
                        <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                             <p class="text-sm text-gray-700 font-medium">Average Days Open (Open RGPs)</p>
                             <p class="text-2xl font-extrabold text-indigo-600 mt-1">${avgDaysOpen} days</p>
                        </div>
                        
                        <div class="p-3 bg-teal-50 rounded-lg border border-teal-200">
                             <p class="text-sm text-gray-700 font-medium">Total Outstanding Qty (All Items)</p>
                             <p class="text-2xl font-extrabold text-teal-600 mt-1">${totalOutstandingQty}</p>
                        </div>
                        
                         <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                             <p class="text-sm text-gray-700 font-medium">Overdue RGPs (30+ days past return)</p>
                             <p class="text-2xl font-extrabold text-red-600 mt-1">${overdueRgpCount}</p>
                        </div>

                    </div>
                    
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Top 5 Vendors (By Open RGP Count)</h3>
                        <div id="analytics-vendor-panel" class="space-y-3">
                           ${renderVendorBarChart(topVendors)}
                        </div>
                    </div>

                     <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Top 5 Users (By Open RGP Count)</h3>
                        <div id="analytics-user-panel" class="space-y-3">
                           ${renderUserBarChart(topUsers)}
                        </div>
                    </div>
                </div>
            `;
        }


        // --- EXPORT LOGIC (UNCHANGED) ---

        /**
         * Helper to convert flattened row data to Excel-friendly array.
         * @param {Array<Object>} rows - The row data array.
         * @returns {Array<Array<any>>}
         */
        function rowsToExportData(rows) {
            const header = [
                'RGP No.', 'Vendor / Sent To', 'Sent By', 'Material Desc', 
                'Issue Date', 'Exp. Return Date', 'Status', 'Days Open', 
                'Initial Qty', 'Returned Qty', 'Outstanding Qty', 'Remarks', 'Unique ID'
            ];
            const data = [header];

            rows.forEach(row => {
                data.push([
                    row.rgpNumber,
                    row.vendor,
                    row.sentBy,
                    row.materialDesc,
                    row.issueDate,
                    row.expectedReturnDate,
                    row.status.toUpperCase(),
                    row.daysOpen,
                    row.initialQty,
                    row.returnedQty,
                    row.outstandingQty,
                    row.remarks || '', // Add remarks
                    row.uniqueId
                ]);
            });
            return data;
        }

        /**
         * Generates and downloads an Excel file.
         * @param {Array<Array<any>>} data - The 2D array of data to export.
         * @param {string} sheetName - The name for the Excel sheet.
         * @param {string} fileName - The name for the downloaded file.
         */
        function exportToExcel(data, sheetName, fileName) {
            try {
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
                XLSX.writeFile(wb, fileName);
                showMessage("Export Successful", `${fileName} has been downloaded.`);
            } catch (e) {
                console.error("Export failed:", e);
                showMessage("Export Failed", "Could not generate the Excel file.", true);
            }
        }

        window.exportPendingRGPList = function() {
            if (filteredRGPData.length === 0) {
                 showMessage("Export Error", "No data to export in the pending list.", true);
                 return;
            }
            const rows = dataToRowData(filteredRGPData);
            const data = rowsToExportData(rows);
            exportToExcel(data, 'Pending RGPs', 'Pending_RGP_List.xlsx');
        }

        window.exportTotalRGPList = function() {
             if (window.filteredTotalRGPData.length === 0) {
                 showMessage("Export Error", "No data to export in the total list.", true);
                 return;
            }
            const rows = dataToRowData(window.filteredTotalRGPData);
            const data = rowsToExportData(rows);
            exportToExcel(data, 'Total RGPs', 'Total_RGP_List.xlsx');
        }
        
         window.exportApprovalRGPList = function() {
             if (window.filteredApprovalRGPData.length === 0) {
                 showMessage("Export Error", "No data to export in the approval list.", true);
                 return;
            }
            const rows = dataToRowData(window.filteredApprovalRGPData);
            const data = rowsToExportData(rows);
            exportToExcel(data, 'RGPs for Approval', 'RGP_Approval_List.xlsx');
        }


        // --- GLOBAL NAVIGATION HELPERS (Called from Dashboard/Analytics UI) ---

        // Function to navigate from metric boxes to Total RGP List with specific filters
        window.navigateToTotalRGPList = function(status, overdue = false) {
            window.totalRGPFilterText = '';
            window.analyticsFilterType = null;
            window.analyticsFilterValue = null;
            window.totalRGPStatusFilter = status;
            window.totalRGPOverdueFilter = overdue;
            // The list view will call filterTotalRGPData() on render
            switchPage('totalList');
        }

        // Function to navigate from Analytics charts/lists to Total RGP List with specific filters
        window.navigateToAnalyticsFilter = function(filterType, filterValue) {
            window.totalRGPFilterText = '';
            window.totalRGPStatusFilter = 'OPEN';
            window.totalRGPOverdueFilter = false;
            window.analyticsFilterType = filterType;
            window.analyticsFilterValue = filterValue;
            // The list view will call filterTotalRGPData() on render
            switchPage('totalList');
        }

        // Function to navigate from RGP List action button to Return Entry
        window.editRGP = function(rgpNumber) {
            // Set the RGP number in state and let the page render function handle the lookup
            selectedRGPNumber = rgpNumber;
            // The state will be used by renderReturnEntryDynamicDetails() to pre-populate the form
            switchPage('returnEntry');
        }
        
        // --- APPLICATION STARTUP ---

        function renderDashboard(data) {
             renderPage(); 
        }

        // Run the initialization: Starts the data fetch which then calls renderPage().
        fetchRGPData(true); 

    </script>
</body>
</html>

